<!doctype html>
<html lang="ru" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nekotexs ‚Äî Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    html,body { height:100%; }
    body {
      font-family: 'Space Grotesk', sans-serif;
      background-color: #0f172a;
      color: #fff;
      background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #0f172a 60%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .gradient-text {
      background: linear-gradient(90deg, #9945FF 0%, #14F195 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .glass-card {
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 1rem;
    }
    ::-webkit-scrollbar { width:8px; height:8px; }
    ::-webkit-scrollbar-thumb { background:#334155; border-radius:6px; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- NAV -->
  <nav class="w-full py-5 px-4 md:px-12 flex justify-between items-center max-w-7xl mx-auto relative z-50">
    <div class="flex items-center gap-3">
      <a href="index.html" class="flex items-center gap-3 group">
        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center p-1 transition-transform group-hover:rotate-12">
          <img src="img/logo.svg" alt="Nekotexs" class="h-8 w-8">
        </div>
        <span class="text-xl font-bold tracking-wider group-hover:text-solana-green transition">Nekotexs</span>
      </a>
    </div>

    <div class="flex items-center gap-4">
      <a href="trade.html" class="px-4 py-2 bg-gradient-to-r from-solana-purple to-solana-green rounded-xl font-bold text-white">Trade</a>
      <a href="withdraw.html" class="px-4 py-2 bg-gradient-to-r from-green-400 to-teal-300 rounded-xl font-bold text-black">Withdraw</a>
      <button id="disconnectBtn" class="text-gray-400 hover:text-white text-sm transition font-semibold">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
      </button>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 py-8 flex-1">
    <header class="mb-8 flex flex-col md:flex-row justify-between items-end gap-6 border-b border-gray-800 pb-8">
      <div>
        <div class="flex items-center gap-2 mb-1">
          <span class="inline-block w-2 h-2 rounded-full bg-solana-green animate-pulse"></span>
          <span class="text-xs text-solana-green font-mono uppercase">System Online</span>
        </div>
        <h1 class="text-3xl md:text-5xl font-bold mb-2">
          <span class="gradient-text">Dashboard</span> Area
        </h1>
        <p id="welcomeMessage" class="text-gray-400 text-sm md:text-base font-mono">Loading data...</p>
      </div>
      <a href="trade.html" class="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-solana-purple to-solana-green rounded-xl font-bold text-white shadow-[0_0_20px_rgba(20,241,149,0.12)] hover:shadow-[0_0_30px_rgba(153,69,255,0.18)] transition transform flex items-center justify-center gap-3 group">
        <i class="fa-solid fa-arrow-right-arrow-left group-hover:rotate-180 transition-transform duration-500"></i>
        <span>TRADE $NKTX</span>
      </a>
    </header>

    <!-- Top cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
      <div class="glass-card p-6">
        <h2 class="text-gray-400 font-bold uppercase text-xs tracking-widest mb-1">Wallet Balance (on-chain)</h2>
        <div class="flex items-baseline gap-2">
          <span id="walletOnchain" class="text-3xl md:text-4xl font-bold text-white">0.00</span>
          <span class="text-sm text-gray-500 font-bold">$NKTX</span>
        </div>
        <p id="walletOnchainUsd" class="text-xs text-gray-500 mt-2">‚âà $0.0000</p>
        <p class="text-xs text-gray-400 mt-2">(on-chain balance for token)</p>
      </div>

      <div class="glass-card p-6">
        <h2 class="text-gray-400 font-bold uppercase text-xs tracking-widest mb-1">Mining / Locked (internal)</h2>
        <div class="flex items-baseline gap-2">
          <span id="miningBalance" class="text-3xl md:text-4xl font-bold text-solana-green">0.0000</span>
          <span class="text-sm text-gray-500 font-bold">$NKTX</span>
        </div>
        <p id="miningUsd" class="text-xs text-gray-500 mt-2">‚âà $0.0000</p>
        <p class="text-xs text-gray-400 mt-2">(–º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –ø–æ–∑–∂–µ)</p>
      </div>

      <div class="glass-card p-6">
        <div class="flex justify-between items-start mb-4">
          <h2 class="text-gray-400 font-bold uppercase text-xs tracking-widest mb-1">Daily Reward</h2>
          <div class="bg-yellow-400/20 p-2 rounded-lg text-yellow-400">
            <i class="fa-solid fa-sun"></i>
          </div>
        </div>
        <div class="mt-1">
          <p class="text-sm text-gray-400">Day <span id="dailyDay">0</span> / 30</p>
          <button id="claimBtn" class="mt-4 w-full bg-gradient-to-r from-[#9945FF] to-[#14F195] py-3 rounded-xl font-bold">Claim Daily</button>
          <p id="claimStatus" class="mt-3 text-xs text-gray-400"></p>
          <p class="mt-2 text-xs text-gray-500">–ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å 1 —Ä–∞–∑ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –¥–µ–Ω—å (Asia/Jerusalem).</p>
        </div>
      </div>
    </div>

    <!-- Address & transactions -->
    <div class="grid lg:grid-cols-3 gap-8 mb-8">
      <div class="lg:col-span-2 glass-card p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-bold flex items-center gap-2">
            <i class="fa-solid fa-list-ul text-gray-400"></i> Recent Transactions
          </h3>
          <button id="viewAllTx" class="text-xs text-solana-purple hover:underline">View All</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-xs text-gray-500 border-b border-gray-800 uppercase tracking-wider">
                <th class="py-3 font-medium">Type</th>
                <th class="py-3 font-medium">Status</th>
                <th class="py-3 font-medium">Date</th>
                <th class="py-3 font-medium text-right">Amount</th>
              </tr>
            </thead>
            <tbody class="text-sm text-gray-300" id="txTableBody">
              <tr><td colspan="4" class="py-4 text-center text-gray-500">Loading history...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="flex flex-col gap-6">
        <div class="glass-card p-6">
          <h3 class="text-sm font-bold uppercase text-gray-400 mb-2">My Address</h3>
          <div class="flex items-center gap-2 cursor-pointer" onclick="copyToClipboard('walletAddressVal')">
            <input type="text" id="walletAddressVal" readonly class="bg-transparent border-none outline-none w-full text-gray-300 font-mono text-xs truncate" value="...">
            <i class="fa-regular fa-copy text-gray-500"></i>
          </div>
        </div>

        <div class="glass-card p-6 bg-blue-900/10">
          <h3 class="text-sm font-bold text-white mb-3">üì¢ Latest Update</h3>
          <p class="text-xs text-gray-400 leading-relaxed mb-3">Listing on Raydium is confirmed for <span class="text-white font-bold">Dec 15</span>.</p>
          <a href="https://x.com/nekotexs_netw" target="_blank" class="text-xs text-solana-green hover:underline">Read on X (Twitter) &rarr;</a>
        </div>
      </div>
    </div>

    <div class="text-center text-xs text-gray-500 mb-6" id="balanceSummarySmall">
      <!-- Will be filled with: On-chain balance + internal locked + USD equivalents -->
      Loading balances...
    </div>

  </main>

  <footer class="border-t border-gray-800 bg-black pt-8 pb-6 px-4">
    <div class="max-w-7xl mx-auto mt-8 pt-6 border-t border-gray-900 flex flex-col md:flex-row justify-between items-center text-xs text-gray-600 font-mono">
      <p>&copy; 2025 Nekotexs Project. All rights reserved.</p>
      <p id="server-time" class="mt-2 md:mt-0 text-solana-green/70">Server Time (Loading...)</p>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs, updateDoc, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyCNjblbAvTzTveZomoMOH4ZhtuLtg-EEfU",
      authDomain: "nekotexs.firebaseapp.com",
      projectId: "nekotexs",
      storageBucket: "nekotexs.firebasestorage.app",
      messagingSenderId: "596436176972",
      appId: "1:596436176972:web:d2870ff374ce52acb9e4e9"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- ELEMENTS ---
    const walletOnchainEl = document.getElementById('walletOnchain');
    const walletOnchainUsdEl = document.getElementById('walletOnchainUsd');
    const miningBalanceEl = document.getElementById('miningBalance');
    const miningUsdEl = document.getElementById('miningUsd');
    const dailyDayEl = document.getElementById('dailyDay');
    const claimBtn = document.getElementById('claimBtn');
    const claimStatusEl = document.getElementById('claimStatus');
    const txTableBody = document.getElementById('txTableBody');
    const walletAddressVal = document.getElementById('walletAddressVal');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const balanceSummarySmall = document.getElementById('balanceSummarySmall');

    // Token / pump.fun id from user message
    const PUMPFUN_COIN_ID = "G5k8Vgh9zTrm9oEkKNuJwA2tHFVh9tgZTYQMY4k5pump";
    // fallback price per token if pump info not available or 0
    const PRICE_FALLBACK = 0.0000408;

    // --- USER ADDRESS ---
    const storedAddress = localStorage.getItem('nekotexs_wallet') || localStorage.getItem('address');
    if (!storedAddress) {
      // redirect to login if no wallet found
      window.location.href = "user/login.html";
    }
    walletAddressVal.value = storedAddress;
    welcomeMessage.textContent = `Wallet Connected: ${storedAddress.slice(0,4)}...${storedAddress.slice(-4)}`;

    // --- FIRESTORE USER REF ---
    const userRef = doc(db, "users", storedAddress);

    // Track global state
    let tokenMint = null;           // on-chain mint address (base58) discovered from pump.fun (if possible)
    let tokenPriceUsd = null;       // USD price per token
    let onchainBalance = 0;         // on-chain token balance (number)
    let miningBalanceInternal = 0;   // from Firestore field earnedBalance
    let lastClaimStored = null;

    // Utility: format number
    function fmt(n, decimals=4) { return Number(n || 0).toFixed(decimals); }

    // Utility: get date string in Asia/Jerusalem for a timestamp
    function jerusalemDateString(ts) {
      try {
        const d = ts ? new Date(Number(ts)) : new Date();
        return d.toLocaleDateString('en-CA', { timeZone: 'Asia/Jerusalem' }); // YYYY-MM-DD
      } catch(e) { return null; }
    }

    // --- 1) Load user doc live from Firestore and update UI ---
    onSnapshot(userRef, snap => {
      if (!snap.exists()) return;
      const data = snap.data();

      miningBalanceInternal = Number(data.earnedBalance || data.miningBalance || 0);
      miningBalanceEl.textContent = fmt(miningBalanceInternal, 4);
      dailyDayEl.textContent = data.dailyDay || 0;
      lastClaimStored = data.lastClaim || null;

      // show internal USD (if price known)
      if (tokenPriceUsd === null) {
        // will update later after price fetch
        miningUsdEl.textContent = '‚âà $0.0000';
      } else {
        miningUsdEl.textContent = `‚âà $${(miningBalanceInternal * tokenPriceUsd).toFixed(6)}`;
      }

      // Update small summary
      updateBalanceSummary();
    });

    // --- 2) Transactions: try global transactions where owner == address ---
    (function subscribeTxs() {
      const txQ = query(collection(db, "transactions"), where("owner","==", storedAddress), orderBy("createdAt","desc"), limit(12));
      // try onSnapshot-like fallback via getDocs + periodic poll for simplicity (onSnapshot is available but keep getDocs as well)
      try {
        // prefer onSnapshot from Firestore to get live updates
        // Note: this will work only if rules allow
        const unsubscribe = onSnapshot(txQ, snap => {
          if (!snap.empty) {
            renderTxFromSnap(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          } else {
            txTableBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">No transactions yet</td></tr>`;
          }
        }, err => {
          console.warn('tx onSnapshot error', err);
        });
      } catch(e) {
        // fallback: one-time getDocs
        getDocs(txQ).then(snap => {
          if (!snap.empty) {
            renderTxFromSnap(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          } else {
            txTableBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">No transactions yet</td></tr>`;
          }
        }).catch(err => {
          console.error('tx getDocs error', err);
        });
      }
    })();

    function renderTxFromSnap(items) {
      if (!items || items.length === 0) {
        txTableBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">No transactions yet</td></tr>`;
        return;
      }
      let html = '';
      items.forEach(tx => {
        const ts = tx.createdAt ? (typeof tx.createdAt === 'object' && tx.createdAt.toDate ? tx.createdAt.toDate() : new Date(Number(tx.createdAt))) : null;
        const date = ts ? ts.toLocaleString() : (tx.date || '‚Äî');
        const amount = Number(tx.amount || tx.value || 0);
        const positive = amount > 0;
        html += `
          <tr class="border-b border-gray-800/50 hover:bg-white/5 transition">
            <td class="py-4">${tx.type || 'Transaction'}</td>
            <td class="py-4"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${tx.status === 'Completed' ? 'bg-green-900/30 text-green-400' : 'bg-yellow-900/30 text-yellow-400'}">${tx.status || 'Pending'}</span></td>
            <td class="py-4 text-gray-500">${date}</td>
            <td class="py-4 text-right font-mono font-bold ${positive ? 'text-solana-green' : 'text-red-400'}">${positive ? '+' : ''}${amount} NKTX</td>
          </tr>
        `;
      });
      txTableBody.innerHTML = html;
    }

    // --- 3) Price & mint discovery from pump.fun ---
    // Try 1: frontend-api.pump.fun JSON
    // Try 2: fetch coin page HTML and parse for mint / price
    async function discoverTokenInfo() {
      try {
        // try JSON API (may be blocked by CORS)
        const apiUrl = `https://frontend-api.pump.fun/coins/${PUMPFUN_COIN_ID}`;
        const r = await fetch(apiUrl);
        if (r.ok) {
          const j = await r.json();
          // expected fields: mint, usd (or price)
          if (j?.mint) tokenMint = j.mint;
          if (j?.usd || j?.price) {
            tokenPriceUsd = Number(j.usd ?? j.price) || null;
          }
        }
      } catch (e) {
        console.warn('frontend-api fetch failed', e);
      }

      // If still missing mint or price, try parsing page HTML
      if (!tokenMint || tokenPriceUsd === null) {
        try {
          const pageUrl = `https://pump.fun/coin/${PUMPFUN_COIN_ID}`;
          const r2 = await fetch(pageUrl);
          if (r2.ok) {
            const html = await r2.text();
            // try to find JSON-like mint or price using regex
            const mintMatch = html.match(/\"mint\"\s*:\s*\"([1-9A-HJ-NP-Za-km-z]{32,44})\"/i)
              || html.match(/data-mint=\"([1-9A-HJ-NP-Za-km-z]{32,44})\"/i);
            if (mintMatch) tokenMint = mintMatch[1];

            const priceMatch = html.match(/\"usd\"\s*:\s*([0-9.]+)/i) || html.match(/\"price\"\s*:\s*([0-9.]+)/i);
            if (priceMatch) tokenPriceUsd = Number(priceMatch[1]);
          }
        } catch (e) {
          console.warn('pump.fun page fetch failed', e);
        }
      }

      // final fallback for price
      if (!tokenPriceUsd || tokenPriceUsd === 0) tokenPriceUsd = PRICE_FALLBACK;

      // update UI (existing miningBalance will update via snapshot; here update USD fields)
      miningUsdEl.textContent = `‚âà $${(miningBalanceInternal * tokenPriceUsd).toFixed(6)}`;

      // if mint discovered ‚Äî fetch on-chain balance
      if (tokenMint) {
        fetchOnchainTokenBalance(tokenMint);
      } else {
        // cannot fetch on-chain without mint ‚Äî keep onchain balance 0 and inform user
        walletOnchainEl.textContent = fmt(0,2);
        walletOnchainUsdEl.textContent = `‚âà $${(0 * tokenPriceUsd).toFixed(6)}`;
        balanceSummarySmall.innerText = `On-chain token mint not found. Showing internal balances only. Price used: $${tokenPriceUsd}`;
      }
    }

    // --- 4) Fetch on-chain balance using Solana RPC ---
    // sums all token accounts for owner with given mint, accounts may have decimals
    async function fetchOnchainTokenBalance(mint) {
      try {
        const RPC = 'https://api.mainnet-beta.solana.com';
        const body = {
          jsonrpc: "2.0",
          id: 1,
          method: "getTokenAccountsByOwner",
          params: [
            storedAddress,
            { mint: mint },
            { encoding: "jsonParsed" }
          ]
        };
        const resp = await fetch(RPC, { method: 'POST', body: JSON.stringify(body) });
        const j = await resp.json();
        let total = 0;
        if (j?.result?.value && Array.isArray(j.result.value)) {
          for (const acct of j.result.value) {
            const info = acct.account?.data?.parsed?.info;
            const ta = info?.tokenAmount;
            if (ta) {
              // If uiAmount available use it, otherwise compute from amount/decimals
              let ui = ta.uiAmount;
              if (ui === undefined || ui === null) {
                const amt = Number(ta.amount || 0);
                const dec = Number(ta.decimals || 0);
                ui = dec ? amt / Math.pow(10, dec) : amt;
              }
              total += Number(ui || 0);
            }
          }
        }
        onchainBalance = total;
        walletOnchainEl.textContent = fmt(onchainBalance, 2);
        walletOnchainUsdEl.textContent = `‚âà $${(onchainBalance * tokenPriceUsd).toFixed(6)}`;

        // update small summary
        updateBalanceSummary();
      } catch (e) {
        console.error('fetchOnchainTokenBalance error', e);
        walletOnchainEl.textContent = fmt(0,2);
        walletOnchainUsdEl.textContent = `‚âà $${(0 * tokenPriceUsd).toFixed(6)}`;
      }
    }

    // --- 5) Daily claim logic (calendar day in Asia/Jerusalem) ---
    // Once per Jerusalem calendar day. lastClaim stored in user doc as milliseconds number or Timestamp.
    claimBtn.addEventListener('click', async () => {
      claimStatusEl.textContent = '';
      try {
        const snap = await getDoc(userRef);
        const data = snap.exists() ? snap.data() : {};
        const lastClaim = data.lastClaim ? (typeof data.lastClaim === 'object' && data.lastClaim.toMillis ? data.lastClaim.toMillis() : Number(data.lastClaim)) : null;

        const now = Date.now();
        const lastDate = lastClaim ? jerusalemDateString(lastClaim) : null;
        const todayDate = jerusalemDateString(now);

        if (lastDate === todayDate) {
          claimStatusEl.textContent = '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å —É–∂–µ –ø–æ–ª—É—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è (–ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ò–µ—Ä—É—Å–∞–ª–∏–º–∞).';
          return;
        }

        // Determine new day count
        const currentDay = data.dailyDay ? Number(data.dailyDay) : 0;
        const newDay = Math.min(currentDay + 1, 30);
        const reward = newDay < 30 ? newDay : 30;

        // Update user doc: earnedBalance (locked), dailyDay, lastClaim
        const newEarned = (Number(data.earnedBalance || data.miningBalance || 0) + reward);

        await updateDoc(userRef, {
          earnedBalance: newEarned,
          dailyDay: newDay,
          lastClaim: now,
          lastLogin: now // optionally update lastLogin
        });

        // create tx record
        await addDoc(collection(db, 'transactions'), {
          owner: storedAddress,
          type: 'Daily Reward',
          amount: reward,
          status: 'Completed',
          createdAt: now
        });

        claimStatusEl.textContent = `–í—ã –ø–æ–ª—É—á–∏–ª–∏ +${reward} NKTX (locked).`;
      } catch (err) {
        console.error('claim error', err);
        claimStatusEl.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–æ–Ω—É—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
      }
    });

    // --- 6) Small helpers & UI updates ---
    function updateBalanceSummary() {
      const internal = Number(miningBalanceInternal || 0);
      const onchain = Number(onchainBalance || 0);
      const price = Number(tokenPriceUsd || PRICE_FALLBACK);

      balanceSummarySmall.innerText = `On-chain: ${fmt(onchain,2)} NKTX (~$${(onchain*price).toFixed(6)}) ‚Ä¢ Locked: ${fmt(internal,4)} NKTX (~$${(internal*price).toFixed(6)}) ‚Ä¢ Price used: $${price}`;
      // also ensure individual USD fields updated
      walletOnchainUsdEl.textContent = `‚âà $${(onchain*price).toFixed(6)}`;
      miningUsdEl.textContent = `‚âà $${(internal*price).toFixed(6)}`;
    }

    // Copy utils
    window.copyToClipboard = (elementId, msg = 'Copied!') => {
      try {
        const el = document.getElementById(elementId);
        const text = el?.value ?? el?.textContent ?? '';
        navigator.clipboard.writeText(text);
        showToast(msg);
      } catch (e) {
        console.error('copy failed', e);
        showToast('Copy failed');
      }
    };

    function showToast(message) {
      const containerId = 'toastContainerLocal';
      let cont = document.getElementById(containerId);
      if (!cont) {
        cont = document.createElement('div');
        cont.id = containerId;
        cont.className = 'fixed bottom-6 right-6 z-50';
        document.body.appendChild(cont);
      }
      const toast = document.createElement('div');
      toast.className = "mb-3 bg-gray-900 border border-solana-green/50 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3";
      toast.innerHTML = `<i class="fa-solid fa-circle-check text-solana-green"></i> <span>${message}</span>`;
      cont.appendChild(toast);
      setTimeout(()=> { toast.style.opacity='0'; setTimeout(()=>toast.remove(),500); }, 2500);
    }

    // Logout
    document.getElementById('disconnectBtn').addEventListener('click', () => {
      localStorage.removeItem('nekotexs_wallet');
      localStorage.removeItem('address');
      window.location.href = "index.html";
    });

    // Server time display
    function updateServerTime() {
      const options = { timeZone: 'Asia/Jerusalem', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, year: 'numeric', month: 'numeric', day: 'numeric' };
      const formatter = new Intl.DateTimeFormat([], options);
      document.getElementById('server-time').innerText = `Server Time (Jerusalem +3): ${formatter.format(new Date())}`;
    }
    updateServerTime(); setInterval(updateServerTime, 1000);

    // Initial discover & fetch
    (async function initAll() {
      await discoverTokenInfo();     // sets tokenMint & tokenPriceUsd and calls fetchOnchainTokenBalance if possible
      // also schedule periodic refreshes (price every 60s, on-chain every 60s)
      setInterval(async ()=> {
        // refresh price & on-chain balance periodically
        await discoverTokenInfo();
      }, 60_000);
    })();

  </script>

</body>
</html>
