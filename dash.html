<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nekotexs Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#0f172a;font-family:'Space Grotesk',sans-serif;color:white;}
.gradient-text{background:linear-gradient(90deg,#9945FF 0%,#14F195 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.glass{background:rgba(255,255,255,0.04);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.08);border-radius:1rem;}
</style>
</head>
<body class="min-h-screen">

<!-- NAVBAR -->
<nav class="max-w-7xl mx-auto py-5 px-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
        <img src="img/logo.svg" class="w-12 h-12 bg-white rounded-full p-1" />
        <span class="text-xl font-bold tracking-wider">Nekotexs</span>
    </div>
    <button id="logoutBtn" class="text-gray-400 hover:text-white"><i class="fa-solid fa-right-from-bracket"></i> Log out</button>
</nav>

<!-- CONTENT -->
<div class="max-w-7xl mx-auto px-4 py-6">
    <h1 class="text-4xl font-bold mb-1"><span class="gradient-text">Dashboard</span></h1>
    <p id="welcomeUser" class="text-gray-400 font-mono mb-6">Loading...</p>

    <!-- NAV BUTTONS -->
    <div class="flex gap-4 mb-6">
        <a href="trade.html" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-500 rounded-lg font-bold">Trade</a>
        <a href="withdraw.html" class="px-4 py-2 bg-gradient-to-r from-green-500 to-teal-400 rounded-lg font-bold">Withdraw</a>
    </div>

    <!-- TOP CARDS -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="glass p-6">
            <h3 class="text-xs uppercase text-gray-400 font-bold">Wallet Balance</h3>
            <div class="flex items-end gap-2 mt-3">
                <span id="walletBalance" class="text-4xl font-bold">0</span>
                <span class="text-gray-500 font-bold">$NKTX</span>
            </div>
        </div>

        <div class="glass p-6">
            <h3 class="text-xs uppercase text-gray-400 font-bold">Mining Balance (Locked)</h3>
            <div class="flex items-end gap-2 mt-3 text-solana-green">
                <span id="miningBalance" class="text-4xl font-bold">0.0000</span>
                <span class="text-gray-500 font-bold">$NKTX</span>
            </div>
        </div>

        <div class="glass p-6">
            <h3 class="text-xs uppercase text-gray-400 font-bold">Daily Reward</h3>
            <p class="text-sm text-gray-400 mt-2">Day <span id="dailyDay">0</span> / 30</p>
            <button id="claimBtn" class="mt-4 px-4 py-2 bg-gradient-to-r from-purple-600 to-green-400 rounded-lg font-bold">Claim Reward</button>
            <p id="claimStatus" class="text-xs text-gray-500 mt-2"></p>
        </div>
    </div>

    <!-- EXTENSION + ADDRESS -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="glass p-6">
            <h3 class="text-xs uppercase text-gray-400 font-bold mb-2">My Wallet Address</h3>
            <div class="flex items-center gap-2">
                <input id="walletAddress" readonly class="bg-transparent w-full font-mono text-sm" />
                <button onclick="copyVal('walletAddress')"><i class="fa-regular fa-copy text-gray-400 hover:text-white"></i></button>
            </div>
        </div>

        <div class="glass p-6">
            <h3 class="text-xs uppercase text-gray-400 font-bold mb-2">Extension Code</h3>
            <div class="flex items-center gap-2">
                <input id="extensionCode" readonly type="password" class="bg-transparent w-full font-mono text-sm" />
                <button onclick="toggleCode()"><i id="eyeIcon" class="fa-solid fa-eye text-gray-400 hover:text-white"></i></button>
                <button onclick="copyVal('extensionCode')"><i class="fa-regular fa-copy text-gray-400 hover:text-white"></i></button>
            </div>
        </div>
    </div>

    <!-- TRANSACTIONS -->
    <div class="glass p-6 mb-10">
        <h3 class="text-lg font-bold mb-4">Recent Transactions</h3>
        <table class="w-full text-left">
            <thead>
                <tr class="text-gray-500 text-xs uppercase">
                    <th class="py-2">Type</th>
                    <th class="py-2">Status</th>
                    <th class="py-2">Date</th>
                    <th class="py-2 text-right">Amount</th>
                </tr>
            </thead>
            <tbody id="txList" class="text-sm"></tbody>
        </table>
    </div>

    <!-- NEWS FEED (TELEGRAM POSTS) -->
    <h2 class="text-2xl font-bold mb-3 gradient-text">Latest News</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="glass p-4">
            <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-post="kayoosh_onlyfans/18" data-width="100%"></script>
        </div>
        <div class="glass p-4">
            <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-post="kayoosh_onlyfans/14" data-width="100%"></script>
        </div>
        <div class="glass p-4">
            <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-post="kayoosh_onlyfans/13" data-width="100%"></script>
        </div>
    </div>
</div>

<!-- FOOTER BALANCE USD -->
<div class="text-center text-gray-500 text-xs py-6" id="usdValue">
    Loading $NKTX value...
</div>

<script>
// FETCH NKTX PRICE
async function fetchPrice() {
    try {
        const res = await fetch(`https://frontend-api.pump.fun/coins/G5k8Vgh9zTrm9oEkKNuJwA2tHFVh9tgZTYQMY4k5pump`);
        const data = await res.json();
        window.nktxPrice = data.usd || 0;
    } catch (e) { console.log(e); }
}

// TOKEN BALANCE
async function fetchTokenBalance() {
    try {
        const url = `https://api.mainnet-beta.solana.com`;
        const body = {
            jsonrpc: "2.0",
            id: 1,
            method: "getTokenAccountsByOwner",
            params: [ userAddress, { mint: "G5k8Vgh9zTrm9oEkKNuJwA2tHFVh9tgZTYQMY4k5pump" }, { encoding: "jsonParsed" } ]
        };

        const res = await fetch(url, { method: "POST", body: JSON.stringify(body) });
        const data = await res.json();

        let amount = 0;
        if (data.result.value.length > 0) {
            amount = data.result.value[0].account.data.parsed.info.tokenAmount.uiAmount || 0;
        }

        document.getElementById("walletBalance").innerText = amount.toFixed(2);
        window.liveBalance = amount;
    } catch (e) { console.log(e); }
}

setInterval(() => {
    if (window.nktxPrice && window.liveBalance !== undefined) {
        document.getElementById("usdValue").innerText = `$${(window.liveBalance * window.nktxPrice).toFixed(4)} USD`;
    }
}, 1000);

fetchPrice();
fetchTokenBalance();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, setDoc, onSnapshot, collection, query, where, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCNjblbAvTzTveZomoMOH4ZhtuLtg-EEfU",
    authDomain: "nekotexs.firebaseapp.com",
    projectId: "nekotexs",
    storageBucket: "nekotexs.firebasestorage.app",
    messagingSenderId: "596436176972",
    appId: "1:596436176972:web:d2870ff374ce52acb9e4e9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* LOCAL WALLET */
const userAddress = localStorage.getItem("nekotexs_wallet");
if (!userAddress) location.href = "login.html";
document.getElementById("walletAddress").value = userAddress;
document.getElementById("welcomeUser").innerText = `Wallet: ${userAddress.slice(0,4)}...${userAddress.slice(-4)}`;

/* LOAD USER */
const userRef = doc(db, "users", userAddress);
onSnapshot(userRef, snap => {
    if (!snap.exists()) return;
    const d = snap.data();

    document.getElementById("walletBalance").innerText = (d.nkTxBalance || 0).toFixed(2);
    document.getElementById("miningBalance").innerText = (d.earnedBalance || 0).toFixed(4);
    document.getElementById("extensionCode").value = d.extensionCode || userAddress;
    document.getElementById("dailyDay").innerText = d.dailyDay || 0;
});

/* TRANSACTIONS */
const txRef = query(collection(db, "transactions"), where("owner", "==", userAddress), orderBy("createdAt", "desc"), limit(10));
onSnapshot(txRef, snap => {
    let html = "";
    snap.forEach(doc => {
        const t = doc.data();
        html += `<tr><td class='py-2'>${t.type}</td><td class='py-2 text-gray-400'>${t.status}</td><td class='py-2 text-gray-400'>${new Date(t.createdAt).toLocaleString()}</td><td class='py-2 text-right ${t.amount>0?'text-green-400':'text-red-400'}'>${t.amount} NKTX</td></tr>`;
    });
    document.getElementById("txList").innerHTML = html || "<tr><td colspan='4' class='text-center py-4 text-gray-500'>No transactions</td></tr>";
});

/* DAILY CLAIM */
document.getElementById("claimBtn").onclick = async () => {
    const snap = await getDoc(userRef);
    const d = snap.data();

    const lastClaim = d.lastClaim || 0;
    const now = Date.now();
    const oneDay = 24*60*60*1000;

    if (now - lastClaim < oneDay) {
        document.getElementById("claimStatus").innerText = "You already claimed today.";
        return;
    }

    let day = d.dailyDay || 0;
    day = Math.min(day + 1, 30);

    const reward = day < 30 ? day : 30;

    await updateDoc(userRef, {
        dailyDay: day,
        lastClaim: now,
        earnedBalance: (d.earnedBalance || 0) + reward
    });

    await addDoc(collection(db, "transactions"), {
        owner: userAddress,
        type: "Daily Reward",
        amount: reward,
        status: "Completed",
        createdAt: now
    });

    document.getElementById("claimStatus").innerText = `Reward +${reward} NKTX added.`;
};

function copyVal(id){navigator.clipboard.writeText(document.getElementById(id).value);} 
function toggleCode(){ const f=document.getElementById('extensionCode'); f.type=f.type==='password'?'text':'password'; }

document.getElementById("logoutBtn").onclick = () => { localStorage.removeItem("nekotexs_wallet"); location.href="index.html"; };
</script>

</body>
</html>
