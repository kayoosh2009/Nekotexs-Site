<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekotexs | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setLogLevel, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- STATE ---
        let db;
        let auth;
        let currentUserWallet = null; // Wallet Address from LocalStorage
        let isAuthReady = false;

        const AVATAR_SEEDS = [
            'Neko', 'Kitsune', 'Panda', 'Robot', 'Designer', 'Adventurer', 'Milo', 'Luna', 'Lily', 'Shadow',
            'Pixel', 'Voxel', 'Bot', 'Star', 'Moon'
        ];

        // --- INIT ---
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    try {
                        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                        else await signInAnonymously(auth);
                    } catch (e) { console.error("Auth failed", e); }
                }
                isAuthReady = true;
                checkWalletAndInit();
            });
        }

        function checkWalletAndInit() {
            currentUserWallet = localStorage.getItem('neko_wallet');
            if (!currentUserWallet) {
                window.location.href = "index.html";
                return;
            }
            
            // Display Wallet Info
            document.getElementById('walletDisplay').textContent = currentUserWallet.substring(0, 6) + '...' + currentUserWallet.slice(-4);
            document.getElementById('avatarImg').src = `https://api.dicebear.com/7.x/identicon/svg?seed=${currentUserWallet}`;
            
            // Start Listeners
            initializeDataListeners(currentUserWallet);
        }

        function initializeDataListeners(wallet) {
            if (!db) return;

            // 1. USER PROFILE & BALANCE LISTENER (Root 'users' collection to match index.html)
            const userRef = doc(db, "users", wallet);

            onSnapshot(userRef, async (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                
                // Basic Data
                const balance = data.balance || 0;
                const name = data.name || "Trader";
                const avatarSeed = data.avatarId ? AVATAR_SEEDS[data.avatarId - 1] : (data.avatarSeed || "Neko");
                
                // Calculate Totals
                const totalWithdrawn = await calculateTotalWithdrawn(wallet);
                const totalMined = balance + totalWithdrawn; // Approximation
                const totalDonated = totalMined * 0.02; // 2% logic

                // Update UI
                updateUI({
                    name, balance, avatarSeed, totalWithdrawn, totalMined, totalDonated
                });

            }, (error) => console.error("Profile sync error:", error));

            // 2. TRANSACTIONS LISTENER (Withdrawals + Syncs)
            loadTransactionHistory(wallet);
        }

        async function calculateTotalWithdrawn(wallet) {
            // Sum up 'amount' from withdrawals collection
            const q = query(collection(db, "withdrawals"), where("wallet", "==", wallet));
            try {
                const querySnapshot = await getDocs(q);
                let total = 0;
                querySnapshot.forEach((doc) => {
                    total += (doc.data().amount || 0);
                });
                return total;
            } catch (e) {
                console.error("Error calculating withdrawals:", e);
                return 0;
            }
        }

        function loadTransactionHistory(wallet) {
            // Listen to withdrawals
            const q = query(collection(db, "withdrawals"), where("wallet", "==", wallet), orderBy("requestDate", "desc"), limit(5));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('transactionsList');
                list.innerHTML = '';

                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500 text-xs text-center p-2">No recent payouts found.</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.requestDate ? new Date(data.requestDate.seconds * 1000).toLocaleDateString() : 'Pending';
                    const statusColor = data.status === 'completed' ? 'text-green-400' : 'text-yellow-400';
                    
                    const html = `
                    <div class="flex justify-between items-center text-xs p-3 bg-black/30 rounded border border-gray-800">
                        <div>
                            <span class="block text-gray-300 font-bold">Withdrawal Request</span>
                            <span class="text-[10px] text-gray-500">${data.masterKey || 'ID: ' + doc.id.slice(0,8)}</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-red-400 font-mono">-${data.amount.toFixed(2)} NEKO</span>
                            <span class="${statusColor} text-[10px] uppercase">${data.status || 'Pending'}</span>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                });
            }, (error) => {
                // Fix for missing index error
                console.log("Transactions index missing, showing simplified view.");
                document.getElementById('transactionsList').innerHTML = '<p class="text-gray-500 text-xs text-center">Transactions loading... (Index building)</p>';
            });
        }

        function updateUI(data) {
            document.getElementById('userNameDisplay').textContent = data.name;
            document.getElementById('balanceDisplay').textContent = data.balance.toFixed(4);
            document.getElementById('totalWithdrawnDisplay').textContent = data.totalWithdrawn.toFixed(2);
            document.getElementById('totalMinedDisplay').textContent = data.totalMined.toFixed(4);
            document.getElementById('totalDonatedDisplay').textContent = data.totalDonated.toFixed(4);
            
            document.getElementById('avatarImg').src = `https://api.dicebear.com/7.x/identicon/svg?seed=${data.avatarSeed}`;
            document.getElementById('profileNameInput').value = data.name;
            
            // Admin Check
            const ADMIN_WALLET = "99LRmqppEMABzsZMYdDqhxqGaLDXZECpFqPBf9dHPdaf";
            if (currentUserWallet === ADMIN_WALLET) {
                document.getElementById('adminBtn').classList.remove('hidden');
            }
        }

        // --- GLOBAL ACTIONS ---
        window.logout = () => {
            localStorage.removeItem('neko_wallet');
            window.location.href = 'index.html';
        };

        window.openProfileModal = () => {
            document.getElementById('profileModal').classList.remove('hidden');
            initAvatarSelector();
        };

        window.closeProfileModal = () => document.getElementById('profileModal').classList.add('hidden');

        window.initAvatarSelector = () => {
            const container = document.getElementById('avatarSelector');
            container.innerHTML = '';
            AVATAR_SEEDS.forEach(seed => {
                const img = document.createElement('img');
                img.src = `https://api.dicebear.com/7.x/identicon/svg?seed=${seed}`;
                img.className = 'w-10 h-10 rounded-full cursor-pointer border-2 border-transparent hover:border-orange-500 transition';
                img.onclick = () => {
                    document.querySelectorAll('#avatarSelector img').forEach(el => el.classList.remove('border-orange-500'));
                    img.classList.add('border-orange-500');
                    img.dataset.selected = "true";
                };
                img.dataset.seed = seed;
                container.appendChild(img);
            });
        };

        window.saveProfile = async () => {
            const name = document.getElementById('profileNameInput').value;
            const selectedImg = document.querySelector('#avatarSelector img[data-selected="true"]');
            const seed = selectedImg ? selectedImg.dataset.seed : 'Neko';
            
            if(name && currentUserWallet) {
                try {
                    await updateDoc(doc(db, "users", currentUserWallet), {
                        name: name,
                        avatarSeed: seed
                    });
                    closeProfileModal();
                } catch(e) {
                    alert("Error saving profile");
                }
            }
        };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #ffffff; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- NAV -->
    <nav class="border-b border-gray-800 bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <!-- LOGO UPDATE -->
                <img src="img/logo.png" alt="Neko Logo" class="w-8 h-8 object-contain">
                <div class="hidden md:flex gap-2 text-sm">
                    <a href="#" class="nav-link px-3 py-1 rounded text-gray-400 transition">Overview</a>
                    <a href="#" class="nav-link px-3 py-1 rounded text-gray-400 transition">Transactions</a>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <a id="adminBtn" href="admin.html" class="hidden bg-red-900/20 text-red-400 border border-red-500/50 px-3 py-1 rounded text-xs font-bold">ADMIN</a>
                <div class="text-right hidden sm:block">
                    <div class="text-[10px] text-gray-500 uppercase">Wallet</div>
                    <div id="walletDisplay" class="font-mono text-xs text-orange-400">...</div>
                </div>
                <button onclick="logout()" class="text-gray-500 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 relative z-20">
        
        <!-- Header -->
        <div class="flex items-end mb-8 border-b border-gray-800 pb-6">
            <img id="avatarImg" class="w-20 h-20 bg-black rounded-xl border-2 border-gray-800" src="">
            <div class="ml-4 mb-1">
                <h1 class="text-2xl font-bold" id="userNameDisplay">Trader</h1>
                <button onclick="openProfileModal()" class="text-xs text-orange-500 hover:text-white">Edit Profile</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            
            <!-- Balance -->
            <div class="glass p-6 rounded-xl col-span-2 border-l-4 border-orange-600 bg-gray-900/40">
                <h3 class="text-gray-500 text-xs uppercase tracking-widest mb-2">Current Balance</h3>
                <div class="flex items-baseline gap-2">
                    <span id="balanceDisplay" class="text-4xl font-bold text-white">0.0000</span>
                    <span class="text-xl text-orange-500">NEKO</span>
                </div>
                <div class="mt-4 flex gap-3">
                    <a href="withdraw.html" class="bg-orange-600 hover:bg-orange-500 text-black px-4 py-2 rounded-lg font-bold text-sm transition">Withdraw</a>
                    <button class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-bold text-sm transition">Swap</button>
                </div>
            </div>

            <!-- Mined -->
            <div class="glass p-5 rounded-xl border border-gray-800">
                <h3 class="text-gray-500 text-xs uppercase tracking-widest mb-1">Total Mined</h3>
                <p class="text-xl font-bold text-green-400" id="totalMinedDisplay">0.0000</p>
                <p class="text-[10px] text-gray-600 mt-1">Lifetime Earnings</p>
            </div>

            <!-- Withdrawn -->
            <div class="glass p-5 rounded-xl border border-gray-800">
                <h3 class="text-gray-500 text-xs uppercase tracking-widest mb-1">Total Withdrawn</h3>
                <p class="text-xl font-bold text-red-400" id="totalWithdrawnDisplay">0.00</p>
                <p class="text-[10px] text-gray-600 mt-1">Processed Requests</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Donation -->
            <div class="glass p-5 rounded-xl border-l-4 border-purple-600">
                <h3 class="text-gray-500 text-xs uppercase tracking-widest mb-1">Charity Impact</h3>
                <p class="text-2xl font-bold text-purple-400" id="totalDonatedDisplay">0.0000</p>
                <p class="text-[10px] text-gray-600 mt-1">2% of your volume</p>
            </div>

            <!-- Transactions -->
            <div class="glass p-5 rounded-xl col-span-2 border border-gray-800">
                <h3 class="text-gray-300 text-sm font-bold mb-4 border-b border-gray-800 pb-2">Payout History (From Extension)</h3>
                <div class="space-y-2" id="transactionsList">
                    <p class="text-gray-600 text-xs text-center">Loading...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="profileModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 p-4">
        <div class="glass p-6 rounded-xl w-full max-w-sm relative">
            <h2 class="text-xl font-bold mb-4">Edit Profile</h2>
            <input type="text" id="profileNameInput" class="w-full bg-black border border-gray-700 p-2 rounded mb-4 text-sm" placeholder="Name">
            <div id="avatarSelector" class="flex flex-wrap gap-2 justify-center mb-6"></div>
            <div class="flex justify-end gap-2">
                <button onclick="closeProfileModal()" class="px-3 py-2 rounded text-gray-400 text-sm">Cancel</button>
                <button onclick="saveProfile()" class="bg-orange-600 px-4 py-2 rounded text-black font-bold text-sm">Save</button>
            </div>
        </div>
    </div>

</body>
</html>
