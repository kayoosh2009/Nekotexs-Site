<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nekotexs Sync</title>
    <style>
        body { font-family: monospace; background: #0f172a; color: #fff; padding: 20px; }
        #status { color: #aaa; }
        .error { color: #ff4444; }
        .success { color: #00ff88; }
    </style>
</head>
<body>
    <h3>Nekotexs Background Sync</h3>
    <div id="status">Initializing...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        // Твоя конфигурация (оставил как есть)
        const firebaseConfig = {
            apiKey: "AIzaSyCNjblbAvTzTveZomoMOH4ZhtuLtg-EEfU",
            authDomain: "nekotexs.firebaseapp.com",
            databaseURL: "https://nekotexs-default-rtdb.firebaseio.com",
            projectId: "nekotexs",
            storageBucket: "nekotexs.firebasestorage.app",
            messagingSenderId: "596436176972",
            appId: "1:596436176972:web:d2870ff374ce52acb9e4e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const statusDiv = document.getElementById('status');

        function log(msg, type = 'normal') {
            console.log(msg);
            statusDiv.innerHTML += `<br><span class="${type}">${msg}</span>`;
        }

        async function sync() {
            try {
                // 1. Получаем параметры
                const params = new URLSearchParams(window.location.search);
                const wallet = params.get('wallet');
                const balanceStr = params.get('balance');

                if (!wallet || !balanceStr) {
                    throw new Error("Missing wallet or balance in URL");
                }

                log(`Wallet: ${wallet.slice(0, 4)}...`, 'normal');
                
                const balance = parseFloat(balanceStr);
                const userRef = doc(db, "users", wallet);

                // 2. Проверяем существование
                const snap = await getDoc(userRef);

                if (snap.exists()) {
                    // Обновляем
                    await updateDoc(userRef, {
                        nkTxBalance: balance,
                        lastExtensionSync: serverTimestamp()
                    });
                    log("Updated existing user.", "success");
                } else {
                    // Создаем
                    await setDoc(userRef, {
                        nkTxBalance: balance,
                        earnedBalance: 0,
                        joinedAt: serverTimestamp(),
                        lastExtensionSync: serverTimestamp(),
                        dailyDay: 0
                    });
                    log("Created new user.", "success");
                }

                log("Sync Complete. Closing...", "success");

                // Даем 1 секунду, чтобы статус обновился и запрос точно ушел
                setTimeout(() => {
                    window.close();
                }, 1000);

            } catch (e) {
                // Если ошибка — выводим её красным и НЕ закрываем окно скриптом.
                // Пусть его закроет таймер-предохранитель из расширения через 15 сек.
                log(`ERROR: ${e.message}`, "error");
                console.error(e);
            }
        }

        sync();
    </script>
</body>
</html>
