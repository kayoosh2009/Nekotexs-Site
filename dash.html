<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekotexs | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setLogLevel, collection, query, where, getDocs, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- STATE & UTILS ---
        let db;
        let auth;
        let currentUserWallet = null; 
        let currentUserId = null;
        let isAuthReady = false;
        
        const AVATAR_SEEDS = [
            'Neko', 'Kitsune', 'Panda', 'Robot', 'Designer', 'Milo', 'Luna', 'Lily', 'Shadow', 'Pixel', 'Voxel', 'Bot', 'Star', 'Moon'
        ];
        
        const ADMIN_WALLET = "99LRmqppEMABzsZMYdDqhxqGaLDXZECpFqPBf9dHPdaf";

        /**
         * Sets up Firebase configuration, initialization, and authentication.
         */
        async function setupFirebase() {
            try {
                // Robust Configuration Parsing
                let firebaseConfig = null;
                if (typeof __firebase_config === 'string' && __firebase_config.length > 0) {
                    firebaseConfig = JSON.parse(__firebase_config);
                }

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase configuration is missing or invalid.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Optional: setLogLevel('debug'); 

                // Set persistence and attempt initial sign-in
                await setPersistence(auth, browserSessionPersistence);
                
                // Attempt sign-in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Auth State Listener to gate all Firestore operations
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    currentUserId = user ? user.uid : null;
                    checkWalletAndInit();
                });

            } catch (error) {
                console.error("Critical Firebase Setup Error:", error);
                // If Firebase fails, still try to proceed with local data or redirect
                isAuthReady = true;
                checkWalletAndInit(); 
            }
        }

        /**
         * Checks for wallet presence and starts data syncing.
         */
        function checkWalletAndInit() {
            currentUserWallet = localStorage.getItem('neko_wallet');
            
            // Critical: If wallet is missing (not logged in), redirect to landing page
            if (!currentUserWallet) {
                // FIX: Use window.location.replace with relative path
                window.location.replace("./index.html");
                return;
            }
            
            // Update static UI elements
            document.getElementById('walletDisplay').textContent = currentUserWallet.substring(0, 6) + '...' + currentUserWallet.slice(-4);
            document.getElementById('avatarImg').src = `https://api.dicebear.com/7.x/identicon/svg?seed=${currentUserWallet}`;
            document.getElementById('userIdDisplay').textContent = currentUserId || 'Anon';
            
            // Only proceed with data listeners if Firebase is initialized and ready
            if (db && isAuthReady && currentUserId) {
                initializeDataListeners(currentUserWallet);
            } else if (isAuthReady) {
                 // Log if Firestore logic is skipped due to missing DB/Auth status
                 console.warn("Firestore data listeners skipped because DB is not ready or Auth state is unresolved.");
            }
        }

        /**
         * Sets up real-time listeners for user data and transactions.
         */
        function initializeDataListeners(wallet) {
            // Path: artifacts/{appId}/public/data/users/{wallet} (Used for public wallet tracking)
            const userRef = doc(db, "artifacts", appId, "public", "data", "users", wallet);

            onSnapshot(userRef, async (docSnap) => {
                let data = docSnap.data();
                
                // If doc doesn't exist, create initial data structure
                if (!docSnap.exists() || !data) {
                    data = {
                        wallet: wallet,
                        balance: 0,
                        name: "New Trader",
                        avatarSeed: AVATAR_SEEDS[0],
                        totalMined: 0,
                        lastLogin: serverTimestamp()
                    };
                    await setDoc(userRef, data, { merge: true });
                }
                
                const balance = data.balance || 0;
                const name = data.name || "Trader";
                const avatarSeed = data.avatarSeed || AVATAR_SEEDS[0];
                const totalMinedBase = data.totalMined || 0;
                
                // Fetch withdrawals to calc total withdrawn
                const totalWithdrawn = await calculateTotalWithdrawn(wallet);
                
                // Total Mined (Base + Current Balance + Withdrawn)
                const totalMined = totalMinedBase + balance + totalWithdrawn; 
                // Charity is 2% of total transaction volume, here approximated from total mined
                const totalDonated = totalMined * 0.02; 

                updateUI({
                    name, balance, avatarSeed, totalWithdrawn, totalMined, totalDonated
                });

            }, (error) => console.error("User Data Sync Error:", error));

            loadTransactionHistory(wallet);
        }

        /**
         * Calculates the sum of all successful withdrawals for the user.
         */
        async function calculateTotalWithdrawn(wallet) {
            // Path: artifacts/{appId}/public/data/withdrawals
            const q = query(collection(db, "artifacts", appId, "public", "data", "withdrawals"), 
                            where("wallet", "==", wallet));
            try {
                const querySnapshot = await getDocs(q);
                let total = 0;
                querySnapshot.forEach((doc) => {
                    // Only count completed/processed withdrawals for 'Total Withdrawn' metric
                    if (doc.data().status === 'completed') {
                        total += (doc.data().amount || 0);
                    }
                });
                return total;
            } catch (e) {
                console.error("Error calculating total withdrawn:", e);
                return 0;
            }
        }

        /**
         * Loads and displays the user's recent transaction history (withdrawals).
         */
        function loadTransactionHistory(wallet) {
            // Path: artifacts/{appId}/public/data/withdrawals
            const ref = collection(db, "artifacts", appId, "public", "data", "withdrawals");
            const list = document.getElementById('transactionsList');

            // Listen for all withdrawals and filter client-side to avoid complex indexing
            onSnapshot(ref, (snapshot) => {
                list.innerHTML = '';
                
                let txs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.wallet === wallet) txs.push(data);
                });
                
                // Sort client-side by request date descending
                txs.sort((a,b) => (b.requestDate?.seconds || 0) - (a.requestDate?.seconds || 0));
                txs = txs.slice(0, 5); // Limit to 5 recent transactions

                if (txs.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-xs text-center p-2">No recent activity found for this wallet.</p>';
                    return;
                }

                txs.forEach((data) => {
                    const date = data.requestDate ? new Date(data.requestDate.seconds * 1000).toLocaleDateString() : 'Processing';
                    const statusText = (data.status || 'pending').charAt(0).toUpperCase() + (data.status || 'pending').slice(1);
                    const statusColor = data.status === 'completed' ? 'text-green-400' : 'text-yellow-400';
                    
                    const html = `
                    <div class="flex justify-between items-center text-xs p-3 bg-black/30 rounded border border-gray-800">
                        <div>
                            <span class="block text-gray-300 font-bold">Withdrawal Request</span>
                            <span class="text-[10px] text-gray-500">${date}</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-red-400 font-mono">-${(data.amount || 0).toFixed(2)} NEKO</span>
                            <span class="${statusColor} text-[10px] uppercase">${statusText}</span>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                });
            }, (error) => console.error("Transaction History Sync Error:", error));
        }

        /**
         * Updates all dynamic elements in the UI.
         */
        function updateUI(data) {
            document.getElementById('userNameDisplay').textContent = data.name;
            document.getElementById('balanceDisplay').textContent = data.balance.toFixed(4);
            document.getElementById('totalWithdrawnDisplay').textContent = data.totalWithdrawn.toFixed(2);
            document.getElementById('totalMinedDisplay').textContent = data.totalMined.toFixed(4);
            document.getElementById('totalDonatedDisplay').textContent = data.totalDonated.toFixed(4);
            
            document.getElementById('avatarImg').src = `https://api.dicebear.com/7.x/identicon/svg?seed=${data.avatarSeed}`;
            
            // Set values in the profile modal
            document.getElementById('profileNameInput').value = data.name;
            initAvatarSelector(data.avatarSeed);
            
            // Show Admin Button if wallet matches admin wallet
            if (currentUserWallet === ADMIN_WALLET) {
                document.getElementById('adminBtn').classList.remove('hidden');
            }
        }
        
        // --- EVENT HANDLERS ---
        
        window.logout = async () => {
            localStorage.removeItem('neko_wallet');
            if (auth) await signOut(auth);
            // FIX: Use window.location.replace with relative path
            window.location.replace('./index.html?action=logout');
        };

        window.openProfileModal = () => {
            document.getElementById('profileModal').classList.remove('hidden');
        };

        window.closeProfileModal = () => document.getElementById('profileModal').classList.add('hidden');

        /**
         * Initializes and sets up click handlers for the avatar selector.
         */
        window.initAvatarSelector = (currentSeed) => {
            const container = document.getElementById('avatarSelector');
            container.innerHTML = '';
            
            AVATAR_SEEDS.forEach(seed => {
                const img = document.createElement('img');
                img.src = `https://api.dicebear.com/7.x/identicon/svg?seed=${seed}`;
                
                let classes = 'w-10 h-10 rounded-full cursor-pointer border-2 border-transparent hover:border-orange-500 transition';
                if (seed === currentSeed) {
                    classes += ' border-orange-500';
                    img.dataset.selected = "true";
                }

                img.className = classes;
                img.onclick = () => {
                    // Deselect all, select current
                    document.querySelectorAll('#avatarSelector img').forEach(el => {
                        el.classList.remove('border-orange-500');
                        delete el.dataset.selected;
                    });
                    img.classList.add('border-orange-500');
                    img.dataset.selected = "true";
                };
                img.dataset.seed = seed;
                container.appendChild(img);
            });
        };

        window.saveProfile = async () => {
            const name = document.getElementById('profileNameInput').value.trim();
            const selectedImg = document.querySelector('#avatarSelector img[data-selected="true"]');
            const newSeed = selectedImg ? selectedImg.dataset.seed : undefined; 
            
            if(name.length < 2) {
                document.getElementById('profileNameInput').classList.add('border-red-500');
                return;
            }
            document.getElementById('profileNameInput').classList.remove('border-red-500');
            
            if(name && currentUserWallet) {
                try {
                    const updateData = { name: name };
                    if (newSeed) {
                        updateData.avatarSeed = newSeed;
                    }
                    
                    await updateDoc(doc(db, "artifacts", appId, "public", "data", "users", currentUserWallet), updateData);
                    closeProfileModal();
                } catch(e) {
                    console.error("Error saving profile:", e);
                    // In a real app, show a friendly error message here
                }
            }
        };

        // --- INIT CALL ---
        window.onload = setupFirebase;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #ffffff; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- NAV -->
    <nav class="border-b border-gray-800 bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://placehold.co/32x32/ff8c00/ffffff?text=NK" alt="Neko Logo" class="w-8 h-8 object-contain rounded">
                <div class="hidden md:flex gap-2 text-sm">
                    <span class="nav-link px-3 py-1 rounded text-white bg-orange-600/20 font-bold">Dashboard</span>
                    <a href="#" class="nav-link px-3 py-1 rounded text-gray-400 transition">Swap</a>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <a id="adminBtn" href="./admin.html" class="hidden bg-red-900/20 text-red-400 border border-red-500/50 px-3 py-1 rounded text-xs font-bold transition hover:bg-red-900/40">ADMIN PANEL</a>
                
                <!-- Display User ID (for debugging/identification) -->
                <div class="text-right hidden sm:block">
                    <div class="text-[10px] text-gray-500 uppercase">User ID (Auth)</div>
                    <div id="userIdDisplay" class="font-mono text-xs text-gray-400">Anon</div>
                </div>

                <div class="text-right hidden sm:block">
                    <div class="text-[10px] text-gray-500 uppercase">Wallet</div>
                    <div id="walletDisplay" class="font-mono text-xs text-orange-400">Loading...</div>
                </div>
                
                <button onclick="logout()" title="Logout" class="text-gray-500 hover:text-white p-2 rounded-full hover:bg-gray-800 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 relative z-20">
        
        <!-- Header -->
        <div class="flex items-end mb-8 border-b border-gray-800 pb-6">
            <img id="avatarImg" class="w-20 h-20 bg-black rounded-xl border-2 border-gray-800" src="https://api.dicebear.com/7.x/identicon/svg?seed=loading">
            <div class="ml-4 mb-1">
                <h1 class="text-2xl font-bold" id="userNameDisplay">Loading...</h1>
                <button onclick="openProfileModal()" class="text-xs text-orange-500 hover:text-white transition">Edit Profile</button>
            </div>
        </div>

        <!-- STATS & ACTION CARDS -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Balance -->
            <div class="glass p-6 rounded-xl sm:col-span-2 border-l-4 border-orange-600 bg-gray-900/40">
                <h3 class="text-gray-500 text-xs uppercase tracking-widest mb-2">Current Balance</h3>
                <div class="flex items-baseline gap-2">
                    <span id="balanceDisplay" class="text-4xl font-bold text-white">0.0000</span>
                    <span class="text-xl text-orange-500">NEKO</span>
                </div>
                <div class="mt-4 flex gap-3">
                    <!-- FIX: Use window.location.replace with relative path -->
                    <a href="./withdraw.html" class="bg-orange-600 hover:bg-orange-500 text-black px-4 py-2 rounded-lg font-bold text-sm transition shadow-lg">Withdraw Funds</a>
                    <button class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-bold text-sm transition">Swap Tokens</button>
                </div>
            </div>

            <!-- Total Mined -->
            <div class="glass p-5 rounded-xl border border-gray-800">
                <h3 class="text-gray-500 text-xs uppercase tracking-widest mb-1">Total Mined</h3>
                <p class="text-xl font-bold text-green-400" id="totalMinedDisplay">0.0000</p>
                <p class="text-[10px] text-gray-600 mt-1">Lifetime Earnings (NEKO)</p>
            </div>

            <!-- Total Donated -->
            <div class="glass p-5 rounded-xl border border-gray-800">
                <h3 class="text-gray-500 text-xs uppercase tracking-widest mb-1">Total Donated</h3>
                <p class="text-xl font-bold text-pink-400" id="totalDonatedDisplay">0.0000</p>
                <p class="text-[10px] text-gray-600 mt-1">2% of All Transactions (NEKO)</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Market Chart Placeholder -->
            <div class="glass p-5 rounded-xl border border-gray-800 lg:col-span-2">
                <h3 class="text-gray-300 text-sm font-bold mb-4 border-b border-gray-800 pb-2">NEKO/SOL Market Overview</h3>
                <div class="h-64 flex items-center justify-center bg-gray-900/50 rounded-lg">
                    <p class="text-gray-600">Chart Placeholder - Real-time data feed simulation</p>
                </div>
                <div class="flex justify-between text-xs mt-3 text-gray-400">
                    <span>Current Price: 0.000002 SOL</span>
                    <span class="text-green-400">+1.5% (24h)</span>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="glass p-5 rounded-xl border border-gray-800">
                <h3 class="text-gray-300 text-sm font-bold mb-4 border-b border-gray-800 pb-2">Recent Activity</h3>
                <div class="space-y-3" id="transactionsList">
                    <p class="text-gray-600 text-xs text-center">Loading transactions...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 p-4">
        <div class="glass p-6 rounded-xl w-full max-w-sm relative shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-orange-500">Edit Profile</h2>
            <label for="profileNameInput" class="text-sm text-gray-400 block mb-1">Display Name</label>
            <input type="text" id="profileNameInput" class="w-full bg-black border border-gray-700 p-2 rounded mb-4 text-sm text-white focus:border-orange-500 focus:outline-none" placeholder="Enter your name">
            
            <label class="text-sm text-gray-400 block mb-2">Select Avatar Seed</label>
            <div id="avatarSelector" class="flex flex-wrap gap-3 justify-center mb-6 p-2 bg-gray-900 rounded-lg border border-gray-800">
                <!-- Avatars loaded here by JS -->
            </div>
            <div class="flex justify-end gap-2 border-t border-gray-800 pt-4">
                <button onclick="closeProfileModal()" class="px-3 py-2 rounded text-gray-400 text-sm hover:bg-gray-800 transition">Cancel</button>
                <button onclick="saveProfile()" class="bg-orange-600 px-4 py-2 rounded text-black font-bold text-sm hover:bg-orange-500 transition">Save Changes</button>
            </div>
        </div>
    </div>

</body>
</html>
