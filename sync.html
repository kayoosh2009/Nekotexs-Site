<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nekotexs Network Sync</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            background-color: #050505;
            color: #00ff88;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-size: 12px;
        }

        .container {
            width: 80%;
            max-width: 350px;
        }

        /* Сканер */
        .scan-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff88, transparent);
            position: absolute;
            top: 0; left: 0;
            animation: scan 2s linear infinite;
            opacity: 0.5;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        /* Прогресс бар */
        .progress-container {
            width: 100%;
            height: 4px;
            background: #1a1a1a;
            margin-top: 15px;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
            transition: width 0.3s ease-out;
        }

        /* Текст */
        .status-text {
            margin-top: 10px; height: 20px;
            text-transform: uppercase;
            letter-spacing: 1px; font-weight: bold;
        }
        .details {
            color: #555; font-size: 10px; margin-top: 5px; height: 60px;
            overflow: hidden; display: flex; flex-direction: column-reverse;
        }
        .log-entry { margin-bottom: 2px; }
        .success { color: #00ff88; }
        .warn { color: #ffcc00; }
        .error { color: #ff4444; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        h2 { margin: 0; font-size: 16px; color: white; margin-bottom: 5px; }
        
        /* Сетка на фоне */
        .bg-grid {
            position: absolute; width: 200%; height: 200%;
            background-image: linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 20px 20px; z-index: -1;
            transform: perspective(500px) rotateX(60deg); top: -50%;
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="scan-line"></div>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <h2>NEKOTEXS BRIDGE</h2>
            <span id="percent">0%</span>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="bar"></div>
        </div>

        <div class="status-text" id="main-status">INITIALIZING...</div>
        <div class="details" id="console-log"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCNjblbAvTzTveZomoMOH4ZhtuLtg-EEfU",
            authDomain: "nekotexs.firebaseapp.com",
            databaseURL: "https://nekotexs-default-rtdb.firebaseio.com",
            projectId: "nekotexs",
            storageBucket: "nekotexs.firebasestorage.app",
            messagingSenderId: "596436176972",
            appId: "1:596436176972:web:d2870ff374ce52acb9e4e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const bar = document.getElementById('bar');
        const percentDiv = document.getElementById('percent');
        const mainStatus = document.getElementById('main-status');
        const consoleDiv = document.getElementById('console-log');
        const delay = ms => new Promise(res => setTimeout(res, ms));

        function addLog(msg, type = '') {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = `> ${msg}`;
            consoleDiv.prepend(div);
        }
        function updateProgress(p) {
            bar.style.width = `${p}%`;
            percentDiv.innerText = `${p}%`;
        }

        async function runSync() {
            try {
                // Получаем параметры
                const params = new URLSearchParams(window.location.search);
                const wallet = params.get('wallet');
                const balanceStr = params.get('balance');
                // Если 'visual' не передан, значит это скрытый фон
                const isVisual = params.get('mode') === 'visual'; 

                // --- ШАГ 1: Старт ---
                updateProgress(5);
                addLog("System initialized");
                if(isVisual) await delay(300);

                if (!wallet || !balanceStr) throw new Error("Missing params");
                
                // --- ШАГ 2: Проверка ---
                mainStatus.innerText = "VERIFYING WALLET...";
                updateProgress(20);
                addLog(`Addr: ${wallet.slice(0,6)}...${wallet.slice(-4)}`);
                if(isVisual) await delay(600);

                // --- ШАГ 3: Фейковое подключение (для красоты) ---
                mainStatus.innerText = "CONNECTING TO NODE...";
                updateProgress(45);
                addLog("Handshake established: wss://solana-mainnet");
                if(isVisual) await delay(500);

                mainStatus.innerText = "CRYPTOGRAPHIC SIGN...";
                updateProgress(60);
                addLog("Validating signatures...");
                if(isVisual) await delay(400);

                // --- ШАГ 4: Реальная запись ---
                mainStatus.innerText = "SYNCING DATABASE...";
                updateProgress(75);
                addLog("Writing to Firestore...", "warn");
                
                const balance = parseFloat(balanceStr);
                const userRef = doc(db, "users", wallet);
                const snap = await getDoc(userRef);

                if (snap.exists()) {
                    await updateDoc(userRef, {
                        nkTxBalance: balance,
                        lastExtensionSync: serverTimestamp()
                    });
                    addLog("User record updated", "success");
                } else {
                    await setDoc(userRef, {
                        nkTxBalance: balance,
                        earnedBalance: 0,
                        joinedAt: serverTimestamp(),
                        lastExtensionSync: serverTimestamp(),
                        dailyDay: 0
                    });
                    addLog("New node created", "success");
                }

                // --- ШАГ 5: Готово ---
                updateProgress(100);
                mainStatus.innerText = "SYNC COMPLETE";
                mainStatus.classList.add("success", "blink");
                addLog("Transaction confirmed", "success");
                
                // Закрываем окно: быстро, если фон, медленно, если визуально
                await delay(isVisual ? 1500 : 500);
                window.close();

            } catch (e) {
                mainStatus.innerText = "SYNC FAILED";
                mainStatus.classList.add("error");
                addLog(e.message, "error");
                console.error(e);
            }
        }

        runSync();
    </script>
</body>
</html>
