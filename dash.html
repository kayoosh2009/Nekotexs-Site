<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekotexs | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- FIREBASE INITIALIZATION & AUTH ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Authentication Setup
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                } else {
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
                isAuthReady = true;
                if (userId) {
                    console.log(`User ID: ${userId}`);
                    document.getElementById('userIdDisplay').textContent = `ID: ${userId}`;
                    initializeDashboard(userId);
                }
            });
        }

        // --- CORE DASHBOARD LOGIC ---

        const AVATAR_OPTIONS = [
            'Neko', 'Kitsune', 'Panda', 'Robot', 'Designer', 'Adventurer', 'Milo', 'Luna', 'Lily', 'Shadow'
        ];
        
        // Function to initialize data listeners after authentication
        function initializeDashboard(uid) {
            if (!db) return;

            // Define Firestore paths
            const userDocRef = doc(db, "artifacts", appId, "users", uid, "profile", "data");
            const publicPath = `artifacts/${appId}/public/data/transactions`;
            const transactionsCollectionRef = db.collection(publicPath); // Using v9 compat for collections

            // 1. Real-time Profile Listener
            onSnapshot(userDocRef, (docSnap) => {
                const profile = docSnap.exists() ? docSnap.data() : { 
                    name: "Trader", 
                    avatarSeed: "Neko", 
                    wallet: "0x..." + uid.substring(0, 4),
                    balance: 0,
                    totalMined: 0,
                    totalWithdrawn: 0,
                    totalDonated: 0
                };
                updateProfileUI(profile);
            }, (error) => {
                console.error("Error reading profile:", error);
                // Handle initial setup if document doesn't exist (only if profile is fully missing)
                if (!docSnap.exists()) {
                     setDoc(userDocRef, { 
                        name: "Trader", 
                        avatarSeed: "Neko", 
                        wallet: "0x..." + uid.substring(0, 4),
                        balance: 0,
                        totalMined: 0,
                        totalWithdrawn: 0,
                        totalDonated: 0
                    }, { merge: true });
                }
            });

            // 2. Real-time Transactions Listener (Simplified for 5 latest items)
            // NOTE: Firestore queries often require indexes, so for simplicity and to avoid index errors, 
            // we will fetch all and sort in memory, even if less efficient for huge datasets.
            onSnapshot(transactionsCollectionRef, (snapshot) => {
                let transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort transactions by timestamp (assuming 'timestamp' field exists)
                transactions.sort((a, b) => b.timestamp - a.timestamp);
                
                updateTransactionsUI(transactions.slice(0, 5)); // Show only the latest 5
            }, (error) => {
                console.error("Error reading transactions:", error);
            });
        }

        // --- UI UPDATE FUNCTIONS ---

        function updateProfileUI(profile) {
            document.getElementById('userNameDisplay').textContent = profile.name || "Trader";
            document.getElementById('balanceDisplay').textContent = (profile.balance || 0).toFixed(4);
            document.getElementById('totalMinedDisplay').textContent = (profile.totalMined || 0).toFixed(4);
            document.getElementById('totalWithdrawnDisplay').textContent = (profile.totalWithdrawn || 0).toFixed(4);
            document.getElementById('totalDonatedDisplay').textContent = (profile.totalDonated || 0).toFixed(4);
            document.getElementById('walletDisplay').textContent = profile.wallet || "N/A";

            const avatarSeed = profile.avatarSeed || "Neko";
            document.getElementById('avatarImg').src = `https://api.dicebear.com/7.x/identicon/svg?seed=${avatarSeed}`;
            document.getElementById('modalUserNameInput').value = profile.name || '';
            
            // Set initial selected avatar in modal
            document.querySelectorAll('.avatar-option').forEach(img => {
                img.classList.remove('selected');
                if (img.dataset.seed === avatarSeed) {
                    img.classList.add('selected');
                }
            });
        }

        function updateTransactionsUI(transactions) {
            const list = document.getElementById('transactionsList');
            list.innerHTML = ''; // Clear existing list

            if (transactions.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-xs text-center p-4">No recent transactions found.</p>';
                return;
            }

            transactions.forEach(tx => {
                const isDeposit = tx.type === 'DEPOSIT' || tx.amount > 0;
                const sign = isDeposit ? '+' : '';
                const colorClass = isDeposit ? 'text-green-400' : 'text-red-400';
                const typeText = isDeposit ? 'Deposit' : 'Withdrawal';

                const txElement = `
                    <div class="flex justify-between items-center border-b border-gray-900 last:border-b-0 py-2">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-white">${typeText}</span>
                            <span class="text-xs text-gray-500">${tx.id.substring(0, 8)}...</span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-semibold ${colorClass}">${sign}${tx.amount.toFixed(4)} NEKO</span>
                            <span class="block text-xs text-gray-500">${new Date(tx.timestamp * 1000).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
                list.innerHTML += txElement;
            });
        }


        // --- EVENT HANDLERS ---
        window.logout = function() {
            signOut(auth).then(() => {
                console.log("User signed out.");
                window.location.reload(); // Reload to force re-authentication/anonymous sign-in
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        }

        window.openProfileModal = function() {
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('modalContent').classList.add('modal-enter');
            // Populate inputs with current data from UI
            document.getElementById('modalUserNameInput').value = document.getElementById('userNameDisplay').textContent;
            
        }

        window.closeProfileModal = function() {
            document.getElementById('profileModal').classList.add('hidden');
            document.getElementById('modalContent').classList.remove('modal-enter');
        }

        window.selectAvatar = function(seed) {
            document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
            document.querySelector(`.avatar-option[data-seed="${seed}"]`).classList.add('selected');
        }

        window.saveProfile = async function() {
            if (!isAuthReady || !userId || !db) return;

            const newName = document.getElementById('modalUserNameInput').value.trim();
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const newAvatarSeed = selectedAvatar ? selectedAvatar.dataset.seed : 'Neko';

            if (newName.length < 2) {
                alert('Username must be at least 2 characters long.');
                return;
            }
            
            const userDocRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            
            try {
                // Update Firestore document
                await updateDoc(userDocRef, {
                    name: newName,
                    avatarSeed: newAvatarSeed
                });

                console.log("Profile updated successfully!");
                closeProfileModal();

            } catch (error) {
                console.error("Error updating profile:", error);
                // Simple feedback for the user
                document.getElementById('modalFeedback').textContent = "Failed to save profile. See console for details.";
                document.getElementById('modalFeedback').classList.remove('hidden');
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505; 
            color: #ffffff; 
        }
        .glass { 
            background: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .nav-link { 
            cursor: pointer; 
            padding: 10px 15px; 
            border-radius: 5px; 
            transition: 0.2s; 
            color: #aaa; 
        }
        .nav-link:hover { 
            background: rgba(255,255,255,0.1); 
            color: white; 
        }
        .avatar-option { 
            width: 50px; 
            height: 50px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: border-color 0.2s; 
            border-radius: 50%; /* Added rounded corners for avatars */
        }
        .avatar-option.selected { 
            border-color: #f97316; 
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.6);
        }
        
        /* Modal Animation */
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- NAVIGATION BAR -->
    <nav class="border-b border-gray-800 bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 bg-orange-600 rounded flex items-center justify-center font-bold text-sm text-black">NK</div>
                <div class="hidden md:flex gap-2">
                    <a class="nav-link text-white font-semibold">Overview</a>
                    <a class="nav-link">Transactions</a>
                    <a class="nav-link">Exchange</a>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- USER ID DISPLAY (Mandatory for multi-user apps) -->
                <div class="hidden md:block text-right">
                    <div id="userIdDisplay" class="font-mono text-xs text-gray-500">ID: Loading...</div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">User ID</div>
                </div>

                <!-- ADMIN BUTTON (Hidden by default) -->
                <a id="adminBtn" href="admin.html" class="hidden bg-gray-900 text-red-400 border border-gray-700 px-3 py-1 rounded text-xs font-bold hover:bg-gray-800 transition">
                    ADMIN PANEL
                </a>

                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">Wallet</div>
                    <div id="walletDisplay" class="font-mono text-xs text-orange-400">Loading...</div>
                </div>
                <button onclick="logout()" class="text-gray-500 hover:text-white transition" aria-label="Logout">
                    <!-- Logout Button -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 max-w-xl mx-auto w-full p-4 md:p-6 relative z-20 space-y-8">
        
        <!-- Profile Header (Stacked) -->
        <div class="flex flex-col items-center justify-center border-b border-gray-800 pb-6">
            <div class="w-24 h-24 bg-black border-4 border-gray-900 rounded-full overflow-hidden shadow-xl relative z-30 mb-4">
                <img id="avatarImg" class="w-full h-full bg-gray-800" src="https://api.dicebear.com/7.x/identicon/svg?seed=Neko" alt="User Avatar">
            </div>
            <div class="text-center">
                <h1 class="text-3xl font-bold" id="userNameDisplay">Trader</h1>
                <p class="text-gray-400 text-sm flex items-center justify-center gap-2 mt-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online
                </p>
                <!-- Edit Profile Button -->
                <button onclick="openProfileModal()" class="text-xs text-orange-500 hover:text-white mt-3 border border-orange-500/50 px-3 py-1 rounded transition">
                    Edit Profile
                </button>
            </div>
        </div>

        <!-- KPI Cards (Stacked Vertically) -->
        <div class="space-y-6">
            
            <!-- Balance Card (Primary) -->
            <div class="glass p-6 rounded-xl border-t border-orange-600/50 bg-gray-900/50 shadow-lg shadow-black/20">
                <h3 class="text-gray-400 text-sm uppercase tracking-widest mb-3">Total Balance</h3>
                <div class="flex items-baseline gap-2">
                    <span id="balanceDisplay" class="text-5xl font-extrabold text-white">0.0000</span>
                    <span class="text-2xl text-orange-500 font-semibold">NEKO</span>
                </div>
                <div class="mt-6 flex flex-wrap gap-4">
                    <!-- Withdraw Button (Link) -->
                    <a href="withdraw.html" class="bg-orange-600 hover:bg-orange-500 text-black px-5 py-3 rounded-xl font-bold transition shadow-lg shadow-orange-600/30 text-base">
                        Withdraw
                    </a>
                    <!-- Exchange Button -->
                    <button class="bg-gray-700 hover:bg-gray-600 text-white px-5 py-3 rounded-xl font-bold transition text-base">
                        Exchange
                    </button>
                </div>
            </div>

            <!-- Secondary Metrics (Simplified Stacking with internal grid) -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                
                <!-- Total Mined Card -->
                <div class="glass p-4 rounded-xl border border-gray-800">
                    <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-1">Total Mined</h3>
                    <p class="text-xl font-bold text-green-400" id="totalMinedDisplay">0.00</p>
                </div>

                <!-- Total Withdrawn Card -->
                <div class="glass p-4 rounded-xl border border-gray-800">
                    <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-1">Total Withdrawn</h3>
                    <p class="text-xl font-bold text-red-400" id="totalWithdrawnDisplay">0.00</p>
                </div>

                <!-- Total Donated Card (Cleaned up, no emoji) -->
                <div class="glass p-4 rounded-xl border border-gray-800">
                    <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-1">Donated to Cats</h3>
                    <p class="text-xl font-bold text-orange-400" id="totalDonatedDisplay">0.00</p>
                </div>
            </div>
        </div>

        <!-- Transactions List -->
        <div class="glass p-6 rounded-xl border border-gray-700">
            <h3 class="text-gray-300 text-xl font-semibold mb-4 border-b border-gray-800 pb-2">Last 5 Transactions</h3>
            <div class="space-y-3" id="transactionsList">
                <p class="text-gray-500 text-xs text-center p-4">No recent transactions found.</p>
            </div>
        </div>
    </main>
    
    <!-- === PROFILE EDIT MODAL === -->
    <div id="profileModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4" onclick="closeProfileModal()">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black bg-opacity-70"></div>

        <!-- Modal Content -->
        <div id="modalContent" class="glass p-8 rounded-xl w-full max-w-md mx-auto relative shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold mb-6 text-white">Edit Profile</h2>

            <!-- Feedback Message -->
            <div id="modalFeedback" class="hidden bg-red-800/30 text-red-300 text-sm p-3 rounded mb-4"></div>

            <div class="space-y-6">
                <!-- Username Input -->
                <div>
                    <label for="modalUserNameInput" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                    <input type="text" id="modalUserNameInput" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-orange-500 focus:border-orange-500" placeholder="Enter new username">
                </div>

                <!-- Avatar Selector -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Select Avatar</label>
                    <div id="avatarSelector" class="flex flex-wrap gap-4 justify-center">
                        <!-- Avatar options are dynamically generated to ensure the `selectAvatar` function is available -->
                        <img class="avatar-option" data-seed="Neko" onclick="selectAvatar('Neko')" src="https://api.dicebear.com/7.x/identicon/svg?seed=Neko" alt="Neko Avatar">
                        <img class="avatar-option" data-seed="Kitsune" onclick="selectAvatar('Kitsune')" src="https://api.dicebear.com/7.x/identicon/svg?seed=Kitsune" alt="Kitsune Avatar">
                        <img class="avatar-option" data-seed="Panda" onclick="selectAvatar('Panda')" src="https://api.dicebear.com/7.x/identicon/svg?seed=Panda" alt="Panda Avatar">
                        <img class="avatar-option" data-seed="Robot" onclick="selectAvatar('Robot')" src="https://api.dicebear.com/7.x/identicon/svg?seed=Robot" alt="Robot Avatar">
                        <img class="avatar-option" data-seed="Designer" onclick="selectAvatar('Designer')" src="https://api.dicebear.com/7.x/identicon/svg?seed=Designer" alt="Designer Avatar">
                        <img class="avatar-option" data-seed="Adventurer" onclick="selectAvatar('Adventurer')" src="https://api.dicebear.com/7.x/identicon/svg?seed=Adventurer" alt="Adventurer Avatar">
                        <img class="avatar-option" data-seed="Milo" onclick="selectAvatar('Milo')" src="https://api.dicebear.com/7.x/identicon/svg?seed=Milo" alt="Milo Avatar">
                        <img class="avatar-option" data-seed="Luna" onclick="selectAvatar('Luna')" src="https://api.dicebear.com/7.x/identicon/svg?seed=Luna" alt="Luna Avatar">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-3 mt-8">
                <button onclick="closeProfileModal()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition">
                    Cancel
                </button>
                <button onclick="saveProfile()" class="bg-orange-600 hover:bg-orange-500 text-black px-4 py-2 rounded-lg font-bold transition">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

</body>
</html>
