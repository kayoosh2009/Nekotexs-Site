<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekotexs | User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Imports (Modular, Required for Canvas Environment) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setLogLevel, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- FIREBASE INITIALIZATION & AUTH ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Authentication Setup
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User signed in previously or via token
                    userId = user.uid;
                } else if (initialAuthToken) {
                    try {
                        // Sign in with the provided custom token
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Error signing in with custom token. Falling back to anonymous:", error);
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                } else {
                    // Fallback to anonymous sign-in
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
                
                isAuthReady = true;
                if (userId) {
                    console.log(`Authenticated User ID: ${userId}`);
                    document.getElementById('userIdDisplay').textContent = `ID: ${userId}`;
                    initializeDashboard(userId);
                }
            });
        }
        
        // --- CORE DASHBOARD LOGIC ---

        const AVATAR_SEEDS = [
            'Neko', 'Kitsune', 'Panda', 'Robot', 'Designer', 'Adventurer', 'Milo', 'Luna', 'Lily', 'Shadow',
            'Pixel', 'Voxel', 'Bot', 'Star', 'Moon' // 15 total seeds
        ];

        function initializeDashboard(uid) {
            if (!db) return;

            // Firestore Paths
            const userDocRef = doc(db, "artifacts", appId, "users", uid, "profile", "data");
            const transactionsCollectionRef = collection(db, "artifacts", appId, "public", "data", "transactions");

            // 1. Real-time Profile Listener
            onSnapshot(userDocRef, (docSnap) => {
                const defaultProfile = { 
                    name: "Trader", 
                    avatarSeed: "Neko", 
                    wallet: uid.substring(0, 6) + '...',
                    balance: 0,
                    totalMined: 0,
                    totalWithdrawn: 0,
                    totalDonated: 0
                };
                
                const profile = docSnap.exists() ? docSnap.data() : defaultProfile;
                
                // Ensure default values are used if fields are missing in Firestore
                const mergedProfile = { ...defaultProfile, ...profile };
                
                updateProfileUI(mergedProfile, uid);
                
                // If profile document didn't exist, create it with default data
                if (!docSnap.exists()) {
                    updateDoc(userDocRef, defaultProfile, { merge: true }).catch(e => console.error("Error setting default profile:", e));
                }
            }, (error) => {
                console.error("Error reading profile:", error);
            });

            // 2. Real-time Transactions Listener
            // Note: Sorting is done in-memory to avoid mandatory index creation errors.
            const txQuery = query(transactionsCollectionRef); 
            
            onSnapshot(txQuery, (snapshot) => {
                let allTransactions = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Filter transactions relevant to the current user (using userId as the wallet ID)
                    if (data.wallet === uid) {
                        allTransactions.push({ id: doc.id, ...data });
                    }
                });
                
                // Sort transactions by timestamp DESC in memory
                allTransactions.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                updateTransactionsUI(allTransactions.slice(0, 5)); // Show only the latest 5
            }, (error) => {
                console.error("Error reading transactions:", error);
                document.getElementById('transactionsList').innerHTML = '<p class="text-red-400 text-xs text-center p-4">Error loading transactions.</p>';
            });
        }

        // --- UI UPDATE FUNCTIONS ---

        function updateProfileUI(profile, uid) {
            document.getElementById('userNameDisplay').textContent = profile.name || "Trader";
            document.getElementById('balanceDisplay').textContent = (profile.balance || 0).toFixed(4);
            document.getElementById('totalMinedDisplay').textContent = (profile.totalMined || 0).toFixed(4);
            document.getElementById('totalWithdrawnDisplay').textContent = (profile.totalWithdrawn || 0).toFixed(4);
            document.getElementById('totalDonatedDisplay').textContent = (profile.totalDonated || 0).toFixed(4);
            
            // Use the actual UID for the wallet display, formatted
            document.getElementById('walletDisplay').textContent = uid.substring(0, 6) + '...' + uid.substring(uid.length - 4);

            const avatarSeed = profile.avatarSeed || "Neko";
            document.getElementById('avatarImg').src = `https://api.dicebear.com/7.x/identicon/svg?seed=${avatarSeed}`;
            document.getElementById('profileNameInput').value = profile.name || '';
            
            // Set initial selected avatar in modal
            document.querySelectorAll('.avatar-option').forEach(img => {
                img.classList.remove('selected');
                if (img.dataset.seed === avatarSeed) {
                    img.classList.add('selected');
                }
            });
        }

        function updateTransactionsUI(transactions) {
            const list = document.getElementById('transactionsList');
            list.innerHTML = ''; // Clear existing list

            if (transactions.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-xs text-center p-2">No recent transactions found.</p>';
                return;
            }

            transactions.forEach(tx => {
                // Determine transaction type and styling
                const isDeposit = tx.type === 'DEPOSIT' || (tx.amount && tx.amount > 0);
                const typeText = isDeposit ? 'Deposit' : 'Withdrawal';
                const sign = isDeposit ? '+' : '';
                const colorClass = isDeposit ? 'text-green-400' : 'text-red-400';
                
                let dateStr = "N/A";
                // Handle Firestore Timestamp object structure
                if (tx.timestamp && tx.timestamp.seconds) {
                    dateStr = new Date(tx.timestamp.seconds * 1000).toLocaleString('en-US', { 
                        day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' 
                    });
                } else {
                     // Fallback for timestamps that are just milliseconds (less common in firestore)
                     dateStr = new Date(tx.timestamp).toLocaleString('en-US', { 
                        day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' 
                    });
                }

                const txElement = `
                    <div class="flex justify-between items-center text-xs p-2 bg-black/30 rounded">
                        <span class="text-gray-400">${dateStr}</span>
                        <span class="${colorClass} font-bold">${sign}${(tx.amount || 0).toFixed(4)} NEKO</span>
                        <span class="text-gray-500">${typeText}</span>
                    </div>
                `;
                list.innerHTML += txElement;
            });
        }

        // --- PROFILE MODAL HANDLERS ---
        
        window.initializeAvatarSelector = function() {
            const selector = document.getElementById('avatarSelector');
            selector.innerHTML = ''; // Clear existing
            
            AVATAR_SEEDS.forEach(seed => {
                const img = document.createElement('img');
                img.src = `https://api.dicebear.com/7.x/identicon/svg?seed=${seed}`;
                img.alt = `${seed} Avatar`;
                img.className = 'avatar-option rounded-full transition duration-150 ease-in-out';
                img.dataset.seed = seed;
                
                img.onclick = () => {
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    img.classList.add('selected');
                };
                selector.appendChild(img);
            });
        }
        
        window.openProfileModal = function() {
            if (!isAuthReady) return;
            // Set current name
            document.getElementById('profileNameInput').value = document.getElementById('userNameDisplay').innerText;
            
            // Highlight current avatar
            const currentSeed = document.getElementById('avatarImg').src.split('seed=')[1];
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.seed === currentSeed) {
                    el.classList.add('selected');
                }
            });
            
            document.getElementById('profileModal').classList.remove('hidden');
        }

        window.closeProfileModal = function() {
            document.getElementById('profileModal').classList.add('hidden');
        }
        
        window.saveProfile = async function() {
            if (!isAuthReady || !userId || !db) return;

            const newName = document.getElementById('profileNameInput').value.trim();
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const newAvatarSeed = selectedAvatar ? selectedAvatar.dataset.seed : 'Neko';

            if (newName.length < 2) {
                // Display message in modal instead of alert
                document.getElementById('modalFeedback').textContent = "Username must be at least 2 characters long.";
                document.getElementById('modalFeedback').classList.remove('hidden');
                return;
            }
            
            const userDocRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            
            try {
                // Update Firestore document
                await updateDoc(userDocRef, {
                    name: newName,
                    avatarSeed: newAvatarSeed
                });

                console.log("Profile updated successfully!");
                document.getElementById('modalFeedback').classList.add('hidden'); // Clear feedback
                closeProfileModal();

            } catch (error) {
                console.error("Error updating profile:", error);
                // Display error message in modal
                document.getElementById('modalFeedback').textContent = "Failed to save profile. Please try again.";
                document.getElementById('modalFeedback').classList.remove('hidden');
            }
        }

        window.logout = function() {
            signOut(auth).then(() => {
                console.log("User signed out.");
                // Reload to force re-authentication (Canvas system will provide a new token/anonymous sign-in)
                window.location.reload(); 
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        }
        
        // Initial call to set up the avatar selector in the modal
        document.addEventListener("DOMContentLoaded", () => {
            window.initializeAvatarSelector();
        });
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505; 
            color: #ffffff; 
        }
        .glass { 
            background: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .nav-link { 
            cursor: pointer; 
            padding: 10px 15px; 
            border-radius: 5px; 
            transition: 0.2s; 
            color: #aaa; 
        }
        .nav-link:hover { 
            background: rgba(255,255,255,0.1); 
            color: white; 
        }
        .avatar-option { 
            width: 50px; 
            height: 50px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: border-color 0.2s; 
            border-radius: 50%; 
        }
        .avatar-option.selected { 
            border-color: #f97316; 
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.6);
        }
        
        /* Modal Animation */
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- NAVIGATION BAR -->
    <nav class="border-b border-gray-800 bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 bg-orange-600 rounded flex items-center justify-center font-bold text-sm text-black">NK</div>
                <div class="hidden md:flex gap-2">
                    <a class="nav-link text-white font-semibold">Overview</a>
                    <a class="nav-link">Transactions</a>
                    <a class="nav-link">Exchange</a>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- USER ID DISPLAY (Mandatory) -->
                <div class="hidden md:block text-right">
                    <div id="userIdDisplay" class="font-mono text-xs text-gray-500">ID: Loading...</div>
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">User ID</div>
                </div>

                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider">Wallet Address</div>
                    <div id="walletDisplay" class="font-mono text-xs text-orange-400">Loading...</div>
                </div>
                <button onclick="logout()" class="text-gray-500 hover:text-white transition" aria-label="Logout">
                    <!-- Logout Button -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 relative z-20">
        
        <!-- Profile Header -->
        <div class="flex items-end mb-10 border-b border-gray-800 pb-6">
            <div class="w-24 h-24 bg-black border-4 border-gray-900 rounded-2xl overflow-hidden shadow-xl relative z-30">
                <img id="avatarImg" class="w-full h-full bg-gray-800" src="https://api.dicebear.com/7.x/identicon/svg?seed=Neko" alt="User Avatar">
            </div>
            <div class="ml-6 mb-2 relative z-30">
                <h1 class="text-3xl font-bold" id="userNameDisplay">Trader</h1>
                <p class="text-gray-400 text-sm flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online
                </p>
                <!-- Edit Profile Button -->
                <button onclick="openProfileModal()" class="text-xs text-orange-500 hover:text-white mt-1 border border-orange-500/50 px-3 py-1 rounded transition">
                    Edit Profile
                </button>
            </div>
        </div>

        <!-- KPI Grid (4-Column Layout) -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            
            <!-- Balance Card (Primary) -->
            <div class="glass p-6 rounded-2xl col-span-2 relative overflow-hidden group border-l-4 border-orange-600 bg-gray-900/50 shadow-lg shadow-black/20">
                <h3 class="text-gray-400 text-sm uppercase tracking-widest mb-2">Total Balance</h3>
                <div class="flex items-baseline gap-2">
                    <span id="balanceDisplay" class="text-4xl font-extrabold text-white">0.0000</span>
                    <span class="text-xl text-orange-500 font-semibold">NEKO</span>
                </div>
                <div class="mt-4 flex flex-wrap gap-4">
                    <!-- Withdraw Button -->
                    <a href="withdraw.html" class="bg-orange-600 hover:bg-orange-500 text-black px-4 py-2 rounded-lg font-bold transition shadow-lg shadow-orange-600/30 text-sm">
                        Withdraw
                    </a>
                    <!-- Exchange Button -->
                    <button class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold transition text-sm">
                        Exchange
                    </button>
                </div>
            </div>

            <!-- Total Mined Card -->
            <div class="glass p-6 rounded-2xl border border-gray-800">
                <h3 class="text-gray-400 text-sm uppercase tracking-widest mb-1">Total Mined</h3>
                <p class="text-2xl font-bold text-green-400" id="totalMinedDisplay">0.00</p>
                <p class="text-xs text-gray-500 mt-2">Node Balance</p>
            </div>

            <!-- Total Withdrawn Card -->
            <div class="glass p-6 rounded-2xl border border-gray-800">
                <h3 class="text-gray-400 text-sm uppercase tracking-widest mb-1">Total Withdrawn</h3>
                <p class="text-2xl font-bold text-red-400" id="totalWithdrawnDisplay">0.00</p>
                <p class="text-xs text-gray-500 mt-2">Completed Requests</p>
            </div>
        </div>

        <!-- Transactions and Donations Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Total Donated Card (Simplified, less bright border) -->
            <div class="glass p-6 rounded-2xl border-l-4 border-purple-600">
                <h3 class="text-gray-400 text-sm uppercase tracking-widest mb-1">Donated to Cats</h3>
                <p class="text-3xl font-bold text-purple-400" id="totalDonatedDisplay">0.00</p>
                <p class="text-xs text-gray-500 mt-2">Automatically from transactions</p>
            </div>

            <!-- Transactions List (Col-span 2) -->
            <div class="glass p-6 rounded-2xl col-span-1 md:col-span-2 border border-gray-700">
                <h3 class="text-gray-300 text-xl font-semibold mb-4 border-b border-gray-800 pb-2">Last 5 Transactions</h3>
                <div class="space-y-3" id="transactionsList">
                    <p class="text-gray-500 text-xs text-center p-2">Loading transactions...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- === PROFILE EDIT MODAL === -->
    <div id="profileModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4" onclick="closeProfileModal()">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
        
        <!-- Modal Content -->
        <div id="modalContent" class="glass p-8 rounded-2xl w-full max-w-md mx-auto relative shadow-2xl modal-enter" onclick="event.stopPropagation()">
            
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-white">Edit Profile</h3>
                <p class="text-gray-400 text-xs mt-2">Name and Avatar</p>
            </div>
            
            <!-- Feedback Message -->
            <div id="modalFeedback" class="hidden bg-red-800/30 text-red-300 text-sm p-3 rounded mb-4"></div>

            <div class="space-y-6">
                <!-- Name Input -->
                <div>
                    <label class="text-xs text-gray-400 uppercase mb-2 block">Your Name (Nickname)</label>
                    <input type="text" id="profileNameInput" maxlength="20"
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-orange-500 focus:outline-none text-sm placeholder-gray-600"
                        placeholder="e.g., CryptoCatLover"
                    >
                </div>

                <!-- Avatar Selection -->
                <div>
                    <label class="text-xs text-gray-400 uppercase mb-2 block">Select Avatar</label>
                    <div id="avatarSelector" class="flex flex-wrap gap-3 justify-center bg-black/30 p-4 rounded-lg">
                        <!-- Avatars injected by JS -->
                    </div>
                </div>
                
                <button onclick="saveProfile()" class="w-full bg-orange-600 hover:bg-orange-500 text-black font-bold py-3 rounded-lg transition uppercase tracking-wider text-sm">
                    Save Changes
                </button>
            </div>
            
            <!-- Close Button -->
            <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-xl">âœ•</button>
        </div>
    </div>

</body>
</html>
