<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekotexs - Withdraw</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        solana: { purple: '#9945FF', green: '#14F195', dark: '#1B1B1B' }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            background-color: #0f172a; 
            color: #ffffff;
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #0f172a 60%); 
            min-height: 100vh;
        }
        .glass-card { 
            background: rgba(255,255,255,0.03); 
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.08); 
            border-radius: 1.5rem; 
            transition: all 0.3s ease;
        }
        .method-card {
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .method-card:hover {
            background: rgba(255,255,255,0.08);
        }
        .method-card.active {
            border-color: #14F195;
            background: rgba(20, 241, 149, 0.1);
        }
    </style>
</head>
<body class="flex flex-col">

    <nav class="w-full py-6 px-4 md:px-12 flex justify-between items-center max-w-7xl mx-auto relative z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center p-1">
                <img src="img/logo.svg" alt="Logo" class="h-6 w-6" onerror="this.style.display='none'">
            </div>
            <span class="text-xl font-bold tracking-wider">Nekotexs</span>
        </div>
        <a href="dash.html" class="text-gray-400 hover:text-white font-semibold transition text-sm uppercase tracking-widest">
            <i class="fa-solid fa-arrow-left mr-2"></i> Back
        </a>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8 w-full flex-grow">
        
        <div class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-2">Withdraw <span class="text-solana-green">Funds</span></h1>
            <p class="text-gray-400">Select a method to cash out your $NKTX</p>
        </div>

        <div class="glass-card p-6 mb-8 flex justify-between items-center bg-gradient-to-r from-solana-purple/20 to-transparent">
            <div>
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Available Balance</p>
                <h2 class="text-3xl font-bold text-white" id="userBalanceDisplay">0.00</h2>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Est. Value</p>
                <h2 class="text-xl font-bold text-solana-green" id="userUSDDisplay">$0.00</h2>
            </div>
        </div>

        <form id="withdrawForm" class="space-y-8">
            
            <div>
                <label class="block text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">1. Select Method</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <div class="glass-card method-card p-4 flex items-center gap-4 active" onclick="selectMethod('zbd', 1000, this)">
                        <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-500">
                            <i class="fa-solid fa-bolt"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">ZBD Wallet</h4>
                            <p class="text-xs text-gray-500">Min: 1,000 NKTX</p>
                        </div>
                        <div class="ml-auto check-icon text-solana-green">
                            <i class="fa-solid fa-circle-check"></i>
                        </div>
                    </div>

                    <div class="glass-card method-card p-4 flex items-center gap-4" onclick="selectMethod('solana', 10000, this)">
                        <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-500">
                            <i class="fa-brands fa-solana"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">Solana</h4>
                            <p class="text-xs text-gray-500">Min: 10,000 NKTX</p>
                        </div>
                        <div class="ml-auto check-icon opacity-0 text-solana-green">
                            <i class="fa-solid fa-circle-check"></i>
                        </div>
                    </div>

                    <div class="glass-card method-card p-4 flex items-center gap-4" onclick="selectMethod('bitcoin', 1000000, this)">
                        <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-500">
                            <i class="fa-brands fa-bitcoin"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">Bitcoin</h4>
                            <p class="text-xs text-gray-500">Min: 1,000,000 NKTX</p>
                        </div>
                        <div class="ml-auto check-icon opacity-0 text-solana-green">
                            <i class="fa-solid fa-circle-check"></i>
                        </div>
                    </div>

                    <div class="glass-card method-card p-4 flex items-center gap-4" onclick="selectMethod('charity', 0, this)">
                        <div class="w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-500">
                            <i class="fa-solid fa-heart"></i>
                        </div>
                        <div>
                            <h4 class="font-bold">Charity</h4>
                            <p class="text-xs text-gray-500">No Minimum</p>
                        </div>
                        <div class="ml-auto check-icon opacity-0 text-solana-green">
                            <i class="fa-solid fa-circle-check"></i>
                        </div>
                    </div>

                </div>
            </div>

            <div class="glass-card p-6 space-y-6">
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Your Email (For Receipt)</label>
                    <input type="email" id="emailInput" required 
                        class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-solana-purple outline-none transition"
                        placeholder="name@example.com">
                    <p class="text-[10px] text-gray-500 mt-1">We will send a secure receipt ID to this email.</p>
                </div>

                <div id="addressField">
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase" id="addressLabel">ZBD Address / Gamertag</label>
                    <input type="text" id="walletInput" required 
                        class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white font-mono focus:border-solana-purple outline-none transition"
                        placeholder="user@zbd.gg">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Amount to Withdraw</label>
                    <div class="relative">
                        <input type="number" id="amountInput" required step="any"
                            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white font-mono text-lg focus:border-solana-green outline-none transition"
                            placeholder="0.00">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold">NKTX</span>
                    </div>
                    <div class="flex justify-between mt-2">
                        <p class="text-xs text-red-400 h-4" id="errorMsg"></p>
                        <button type="button" id="maxBtn" class="text-xs text-solana-green font-bold hover:underline">MAX</button>
                    </div>
                </div>

            </div>

            <button type="submit" id="submitBtn" class="w-full py-4 bg-gradient-to-r from-solana-purple to-solana-green rounded-xl font-bold text-black text-lg shadow-lg hover:shadow-solana-green/30 hover:scale-[1.01] transition disabled:opacity-50 disabled:cursor-not-allowed">
                Confirm Withdrawal
            </button>

        </form>
    </div>

    <div id="successModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4">
        <div class="glass-card p-8 max-w-md w-full text-center relative">
            <div class="w-16 h-16 bg-solana-green rounded-full flex items-center justify-center text-black text-2xl mx-auto mb-6 shadow-[0_0_20px_#14F195]">
                <i class="fa-solid fa-check"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Request Submitted!</h2>
            <p class="text-gray-400 text-sm mb-6">Your withdrawal is being processed manually. We have deducted the balance.</p>
            
            <div class="bg-black/50 p-4 rounded-xl border border-white/10 mb-6">
                <p class="text-xs text-gray-500 uppercase mb-1">Your Security Receipt ID</p>
                <div class="flex items-center justify-between gap-2">
                    <code class="text-solana-green font-mono text-lg" id="receiptIdDisplay">...</code>
                    <button onclick="copyReceipt()" class="text-gray-400 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2">Save this! You will need it if you contact support.</p>
            </div>

            <button onclick="window.location.href='dash.html'" class="w-full py-3 bg-white text-black rounded-xl font-bold hover:bg-gray-200">
                Back to Dashboard
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, doc, getDoc, runTransaction, serverTimestamp, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        // ТВОЙ КОНФИГ
        const firebaseConfig = {
            apiKey: "AIzaSyCNjblbAvTzTveZomoMOH4ZhtuLtg-EEfU",
            authDomain: "nekotexs.firebaseapp.com",
            projectId: "nekotexs",
            storageBucket: "nekotexs.appspot.com",
            messagingSenderId: "596436176972",
            appId: "1:596436176972:web:d2870ff374ce52acb9e4e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const userAddress = localStorage.getItem("nekotexs_wallet");
        if (!userAddress) location.href = "login.html";

        // State
        let currentBalance = 0;
        let currentMethod = 'zbd';
        let minLimit = 1000;
        let nktxPrice = localStorage.getItem("nktx_last_price") || 0.00000369;

        // UI References
        const userBalDisplay = document.getElementById('userBalanceDisplay');
        const userUsdDisplay = document.getElementById('userUSDDisplay');
        const amountInput = document.getElementById('amountInput');
        const errorMsg = document.getElementById('errorMsg');
        const submitBtn = document.getElementById('submitBtn');

        // 1. Initial Load
        async function loadData() {
            const userRef = doc(db, "users", userAddress);
            const snap = await getDoc(userRef);
            if (snap.exists()) {
                const d = snap.data();
                // Суммируем баланс как в dash.html
                const earned = Number(d.earnedBalance || 0);
                const mined = Number(d.nkTxBalance || 0);
                currentBalance = earned + mined;
                
                userBalDisplay.innerText = currentBalance.toFixed(2);
                userUsdDisplay.innerText = `≈ $${(currentBalance * nktxPrice).toFixed(4)}`;
            }
        }
        loadData();

        // 2. Method Selection Logic
        window.selectMethod = (method, min, el) => {
            currentMethod = method;
            minLimit = min;

            // Visual update
            document.querySelectorAll('.method-card').forEach(c => {
                c.classList.remove('active');
                c.querySelector('.check-icon').classList.add('opacity-0');
            });
            el.classList.add('active');
            el.querySelector('.check-icon').classList.remove('opacity-0');

            // Input update
            const lbl = document.getElementById('addressLabel');
            const inp = document.getElementById('walletInput');
            
            if (method === 'zbd') {
                lbl.innerText = 'ZBD Address / Gamertag';
                inp.placeholder = 'username@zbd.gg';
                inp.disabled = false;
            } else if (method === 'bitcoin') {
                lbl.innerText = 'Bitcoin Wallet Address (BTC Network)';
                inp.placeholder = 'bc1q...';
                inp.disabled = false;
            } else if (method === 'solana') {
                lbl.innerText = 'Solana Wallet Address';
                inp.placeholder = 'Address...';
                inp.value = userAddress; // Auto-fill solana with login wallet
                inp.disabled = false;
            } else if (method === 'charity') {
                lbl.innerText = 'Charity Message (Optional)';
                inp.placeholder = 'Donate to save cats...';
                inp.value = '';
                inp.disabled = false;
            }

            validate();
        };

        // 3. Validation Logic
        function validate() {
            const val = parseFloat(amountInput.value);
            const email = document.getElementById('emailInput').value;
            const wallet = document.getElementById('walletInput').value;
            
            errorMsg.innerText = '';
            submitBtn.disabled = true;

            if (!email) return;
            if (currentMethod !== 'charity' && !wallet) return; // Wallet required unless charity

            if (isNaN(val) || val <= 0) {
                // errorMsg.innerText = 'Enter amount';
                return;
            }
            if (val < minLimit) {
                errorMsg.innerText = `Minimum for ${currentMethod} is ${minLimit} NKTX`;
                return;
            }
            if (val > currentBalance) {
                errorMsg.innerText = 'Insufficient balance';
                return;
            }

            submitBtn.disabled = false;
        }

        // Listeners
        amountInput.addEventListener('input', validate);
        document.getElementById('emailInput').addEventListener('input', validate);
        document.getElementById('walletInput').addEventListener('input', validate);
        
        document.getElementById('maxBtn').onclick = () => {
            amountInput.value = currentBalance;
            validate();
        };

        // 4. Submit Logic with Transaction
        document.getElementById('withdrawForm').onsubmit = async (e) => {
            e.preventDefault();
            if (submitBtn.disabled) return;
            
            submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';
            
            const amount = parseFloat(amountInput.value);
            const email = document.getElementById('emailInput').value;
            const wallet = document.getElementById('walletInput').value;
            
            // Generate Receipt ID
            const receiptId = 'NKTX-' + Math.random().toString(36).substr(2, 9).toUpperCase();

            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", userAddress);
                    const sfDoc = await transaction.get(userRef);
                    if (!sfDoc.exists()) throw "User does not exist!";

                    const d = sfDoc.data();
                    const totalBal = (Number(d.earnedBalance || 0) + Number(d.nkTxBalance || 0));

                    if (totalBal < amount) {
                        throw "Insufficient funds!";
                    }

                    // Списываем с earnedBalance (или уводим в минус, если не хватает, но логика totalBal защищает)
                    // Лучше списывать пропорционально, но для простоты спишем с earnedBalance.
                    // Если earnedBalance < amount, придется списывать с nkTxBalance. 
                    // Упрощение: просто уменьшаем earnedBalance. (Firebase сам разберется с математикой, главное отображение).
                    // ВАЖНО: Так как у тебя два поля, безопаснее всего просто вычесть из earnedBalance.
                    // Если он станет отрицательным - не страшно, так как totalBalance (отображаемый) уменьшится верно.
                    
                    const newEarned = (Number(d.earnedBalance || 0) - amount);

                    transaction.update(userRef, { earnedBalance: newEarned });

                    // Создаем заявку на вывод
                    const withdrawRef = doc(collection(db, "withdrawals"));
                    transaction.set(withdrawRef, {
                        userId: userAddress,
                        email: email,
                        method: currentMethod,
                        walletAddress: wallet,
                        amount: amount,
                        receiptId: receiptId,
                        status: "pending", // Ждет ручной обработки
                        createdAt: serverTimestamp()
                    });

                    // Запись в историю транзакций
                    const txRef = doc(collection(db, "transactions"));
                    transaction.set(txRef, {
                        owner: userAddress,
                        type: `Withdraw (${currentMethod})`,
                        amount: -amount,
                        status: "Pending",
                        receiptId: receiptId,
                        createdAt: serverTimestamp()
                    });
                });

                // Success UI
                document.getElementById('receiptIdDisplay').innerText = receiptId;
                document.getElementById('successModal').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("Error: " + err);
                submitBtn.innerHTML = 'Try Again';
                submitBtn.disabled = false;
            }
        };

        window.copyReceipt = () => {
            navigator.clipboard.writeText(document.getElementById('receiptIdDisplay').innerText);
            alert("Receipt ID Copied!");
        }
    </script>
</body>
</html>
